<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>18+ Verification • Blossom n Blade</title>
<style>
  :root{ --bg:#0e0a0d; --panel:#171017; --ink:#efe6ee; --muted:#bba9b6; --plum:#4B1F3C; --wine:#6E0F2E; --line:#2a1a25 }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink); font:600 16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(0deg, rgba(14,10,13,.88), rgba(14,10,13,.88)),
               url("/images/gothic-bg.jpg") center/cover no-repeat fixed;
  }
  header{padding:14px 16px; border-bottom:1px solid var(--line); background:linear-gradient(180deg,#1a121a,#120a11)}
  .wrap{max-width:760px; margin:40px auto; padding:0 14px}
  .card{border:1px solid var(--line); border-radius:16px; overflow:hidden; background:linear-gradient(180deg,#1a121a,#120a11);
        box-shadow:0 12px 30px rgba(0,0,0,.45)}
  .hd{padding:16px; border-bottom:1px solid #241624; display:flex; align-items:center; gap:12px}
  .dot{width:22px;height:22px;border-radius:50%; background:conic-gradient(from 220deg,var(--wine),var(--plum))}
  h1{margin:0; font-size:18px}
  .bd{padding:18px}
  .row{display:flex; align-items:flex-start; gap:10px; margin:10px 0}
  input[type="checkbox"]{width:20px; height:20px; margin-top:2px}
  label{font-weight:500; color:#e7d4e6}
  .muted{color:var(--muted); font-size:13px}
  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}
  .btn{border:none; border-radius:999px; padding:10px 14px; cursor:pointer; font-weight:800; color:white;
       background:linear-gradient(90deg,var(--plum),var(--wine))}
  .btn.ghost{background:#2a1a25}
  .note{margin-top:10px; font-size:13px; color:#cbbdca}
  .ok{padding:10px 12px; border-radius:10px; background:#142114; color:#d8ffd8; border:1px solid #234123}
  .warn{padding:10px 12px; border-radius:10px; background:#2a1a25; color:#f6d7ef; border:1px dashed #3a203a}
  a{color:#e7bddf; text-decoration:underline}
</style>
</head>
<body>
<header>$1 of every subscription goes to a Domestic Violence charity.</header>

<div class="wrap">
  <div class="card">
    <div class="hd"><div class="dot" aria-hidden="true"></div><h1>18+ Verification</h1></div>
    <div class="bd">
      <div id="status" class="ok" style="display:none;">Verified — you’re good. Click **Continue** below.</div>

      <form id="form">
        <div class="row">
          <input id="c1" type="checkbox" />
          <label for="c1">I confirm I’m **18 or older**.</label>
        </div>
        <div class="row">
          <input id="c2" type="checkbox" />
          <label for="c2">I accept the site’s **rules & policies** (PG-13 by default; words-only erotic chat unlocked by coins).</label>
        </div>

        <div class="actions">
          <button id="go" class="btn" type="submit" disabled>Continue</button>
          <button id="reset" class="btn ghost" type="button">Reset & verify again</button>
        </div>
        <div class="note muted">We store a local receipt for 30 days.</div>
      </form>

      <div id="receipt" class="muted" style="margin-top:10px"></div>
      <div id="loopwarn" class="warn" style="display:none; margin-top:10px">
        If you keep bouncing back here, your browser may be blocking local storage. Try a hard refresh (Ctrl/Cmd+F5).
      </div>
    </div>
  </div>
</div>

<script>
/* --- unified keys (ALL pages read these) --- */
const KEY_MAIN = "bb.ageVerifiedUntil";
const KEY_LEG1 = "bb.age_verified_until";
const KEY_FLAG = "bb.ageVerified";

const qs = new URLSearchParams(location.search);
const man  = (qs.get("man")||"").toLowerCase();
const plan = (qs.get("plan")||"").toLowerCase();
const next = qs.get("next"); // may be /alexander or /rooms/alexander etc.

const untilNow = Number(localStorage.getItem(KEY_MAIN) || 0);
const status = document.getElementById("status");
const form = document.getElementById("form");
const c1 = document.getElementById("c1");
const c2 = document.getElementById("c2");
const go = document.getElementById("go");
const resetBtn = document.getElementById("reset");
const receipt = document.getElementById("receipt");
const loopwarn = document.getElementById("loopwarn");

/* normalizes pretty paths to real files so we don't 404 */
function normalizeNext(n){
  if (!n) return null;
  try{
    const u = new URL(n, location.origin);
    const p = u.pathname.replace(/\/+$/,'').toLowerCase();
    const m = p.match(/^\/(?:rooms\/)?(alexander|blade|dylan|grayson|silas|jesse)$/i);
    if (m){
      return `/chat.html?man=${m[1].toLowerCase()}`;
    }
    return u.pathname + u.search + u.hash;
  }catch(e){ return n; }
}
function storageWorks(){
  try{ localStorage.setItem("__bbprobe","1"); const ok=localStorage.getItem("__bbprobe")==="1"; localStorage.removeItem("__bbprobe"); return ok; }
  catch(e){ return false; }
}
function saveVerification(days=30){
  const until = Date.now() + days*24*60*60*1000;
  localStorage.setItem(KEY_MAIN, String(until));
  localStorage.setItem(KEY_LEG1, String(until));
  localStorage.setItem(KEY_FLAG, "1");
  return until;
}
function targetURL(){
  const normalized = normalizeNext(next);
  if (normalized) return normalized;
  if (plan) return `/pay.html?man=${encodeURIComponent(man)}&plan=${encodeURIComponent(plan)}`;
  if (man)  return `/chat.html?man=${encodeURIComponent(man)}`;
  return "/index.html";
}
function updateUIFromSaved(){
  if (untilNow && untilNow > Date.now()){
    status.style.display = "block";
    const when = new Date(untilNow).toLocaleString();
    receipt.textContent = `Saved receipt expires: ${when}`;
    go.disabled = false;
  }
}
function redirectIfVerified(){
  if (untilNow && untilNow > Date.now()){
    if (next || plan || man){ location.replace(targetURL()); }
  }
}
function toggleGo(){ go.disabled = !(c1.checked && c2.checked); }
c1.addEventListener("change", toggleGo);
c2.addEventListener("change", toggleGo);
form.addEventListener("submit",(e)=>{
  e.preventDefault();
  const until = saveVerification(30);
  const when = new Date(until).toLocaleString();
  status.style.display = "block";
  receipt.textContent = `Saved receipt expires: ${when}`;
  go.disabled = false;
  location.replace(targetURL());
});
resetBtn.addEventListener("click", ()=>{
  localStorage.removeItem(KEY_MAIN);
  localStorage.removeItem(KEY_LEG1);
  localStorage.removeItem(KEY_FLAG);
  location.reload();
});
updateUIFromSaved();
redirectIfVerified();
if (!storageWorks()) loopwarn.style.display = "block";
</script>
</body>
</html>
