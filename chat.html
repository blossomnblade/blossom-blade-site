<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat · Blossom & Blade</title>
  <link rel="icon" href="/images/logo.jpg" />
  <meta name="color-scheme" content="dark only" />
  <style>
    :root{
      --bg:#0b0a0f; --ink:#ffffff; --muted:#cfc9db;
      --veil:rgba(0,0,0,.32);
      --panel:#0f0f19;
      --you:#8b5cf6;            /* your bubble */
      --him:#0f1322;            /* his bubble */
      --line:rgba(255,255,255,.18);
      --radius:16px;
      --shadow:0 14px 40px rgba(0,0,0,.50);
      --accent1:#c084fc; --accent2:#a855f7;
      --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family: ui-rounded, "SF Pro Rounded", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg) center/cover fixed no-repeat;
    }
    body::after{content:""; position:fixed; inset:0; background:var(--veil); z-index:-1}

    .wrap{max-width:980px; margin:0 auto; padding:24px 16px 22px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:8px}
    .dot{width:10px; height:10px; background:#b57cff; border-radius:50%}
    h1{margin:0; font-size:22px; letter-spacing:.3px}
    .chip{
      margin-left:auto; background:rgba(0,0,0,.55); border:1px solid var(--line);
      border-radius:999px; padding:6px 10px; font-weight:800; font-size:12px
    }

    .panel{
      border:1px solid var(--line); border-radius:var(--radius); background:rgba(0,0,0,.45);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    #log{
      max-height:64vh; overflow:auto; padding:18px;
      display:flex; flex-direction:column; gap:14px;
      scroll-behavior:smooth;
      background:linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.35));
    }
    .row{display:flex}
    .row.you{justify-content:flex-end}
    .bubble{
      max-width:72ch; padding:14px 16px; border-radius:14px; line-height:1.4; white-space:pre-wrap;
      border:1px solid var(--line); box-shadow:var(--shadow)
    }
    .you .bubble{background:var(--you); color:#140a1d}
    .him .bubble{background:var(--him); color:#dfe7ff}

    /* form */
    form{display:flex; gap:10px; align-items:stretch; padding:12px; background:rgba(0,0,0,.5); border-top:1px solid var(--line)}
    textarea{
      flex:1; resize:none; min-height:48px; max-height:32vh; padding:14px; border-radius:12px;
      border:1px solid var(--line); background:#0c0f19; color:var(--ink); outline:none;
      box-shadow:inset 0 0 0 999px rgba(255,255,255,0); transition:border-color .15s ease;
    }
    textarea:focus{border-color:rgba(255,255,255,.35)}
    button{
      padding:0 18px; border-radius:12px; border:0; cursor:pointer; font-weight:900;
      background:linear-gradient(180deg,var(--accent1),var(--accent2)); color:#0c0613; box-shadow:var(--shadow);
      transition:filter .15s ease, transform .08s ease;
    }
    button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
    .admin{position:fixed; right:16px; bottom:16px; background:#0d1e14; color:#caffd1;
      border:1px solid #2b503a; padding:12px 16px; border-radius:999px; text-decoration:none; font-weight:900}

    /* modals */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); padding:20px}
    .modal.on{display:grid}
    .sheet{max-width:720px; width:100%; background:rgba(0,0,0,.78); border:1px solid var(--line); border-radius:16px; padding:18px; box-shadow:var(--shadow)}
    .sheet h2{margin:4px 0 10px}
    .gate label{display:flex; gap:12px; margin:10px 0; line-height:1.35}
    .gate input{transform:translateY(2px)}
    .ok{margin-top:12px}
    .note{font-size:12.5px; color:var(--muted); margin-top:8px}
  </style>
</head>
<body id="body">
  <div class="wrap">
    <header>
      <span class="dot" aria-hidden="true"></span>
      <h1>Blossom &amp; Blade</h1>
      <span class="chip" id="manChip">Jesse</span>
    </header>

    <section class="panel">
      <div id="log" aria-live="polite" aria-label="Messages"></div>
      <form id="form" autocomplete="off">
        <textarea id="input" placeholder="Say hi…" rows="2"></textarea>
        <button id="send" type="submit">Send</button>
      </form>
    </section>
  </div>

  <a class="admin" href="/pay.html">Admin / Pricing</a>

  <!-- NEW: Safety & Non-Violence Agreement (shows first) -->
  <div class="modal" id="stanceModal" role="dialog" aria-modal="true" aria-labelledby="stanceTitle">
    <div class="sheet">
      <h2 id="stanceTitle">Safety & Non-Violence Agreement</h2>
      <div class="gate">
        <p style="margin:6px 0 2px">
          We don’t condone violence or harassment—ever. We support victims and survivors. We support <b>Charlie Kent</b>.
          By continuing, you agree not to promote or excuse real-world violence here. Violations may result in termination.
        </p>
        <label><input id="sAgree" type="checkbox" />
          <span>I agree to the Safety &amp; Non-Violence statement.</span>
        </label>
      </div>
      <button class="ok" id="stanceOk" disabled>Continue</button>
      <div class="note">This notice helps keep our spaces safe. Thanks for having standards.</div>
    </div>
  </div>

  <!-- Age gate (24h) -->
  <div class="modal" id="ageModal" role="dialog" aria-modal="true" aria-labelledby="ageTitle">
    <div class="sheet">
      <h2 id="ageTitle">Quick check</h2>
      <div class="gate">
        <label><input id="g18" type="checkbox" /> I confirm I am <b>18+</b> and understand this is consensual fantasy roleplay.</label>
        <label><input id="g988" type="checkbox" /> I understand help is available — call/text <b>988</b> in the U.S. if in crisis.</label>
      </div>
      <button class="ok" id="gateOk" disabled>Continue</button>
    </div>
  </div>

  <script>
    /* ---------- background per man ---------- */
    const qs = new URLSearchParams(location.search);
    const man = (qs.get('man') || 'jesse').toLowerCase();
    const bgMap = {
      alexander:'/images/bg_alexander_boardroom.jpg',
      dylan:'/images/dylan-garage.jpg',
      jesse:'/images/jesse_bg.jpg',
      grayson:'/images/grayson-bg.jpg',
      silas:'/images/bg_silas_stage.jpg',
      blade:'/images/blade-woods.jpg'
    };
    document.getElementById('body').style.backgroundImage =
      `url("${bgMap[man] || '/images/gothic-bg.jpg'}")`;
    document.getElementById('manChip').textContent =
      man.charAt(0).toUpperCase() + man.slice(1);

    /* ---------- simple chat plumbing ---------- */
    const log = document.getElementById('log');
    const form = document.getElementById('form');
    const input = document.getElementById('input');

    function bubble(who, text){
      const row = document.createElement('div');
      row.className = 'row ' + (who === 'you' ? 'you' : 'him');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      row.appendChild(b);
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }

    // First line – light intro
    bubble('him', {
      alexander: "Good timing. I was thinking about you.",
      dylan:     "Hey trouble—hands in mine, eyes on me.",
      jesse:     "Nice to meet you, darlin’. Tell me one detail.",
      grayson:   "Well… you came to me. Start with one line.",
      silas:     "Hey love. I’ve got a melody for you.",
      blade:     "Glitch on my side—say it again, slower."
    }[man] || "You made it. Let’s start with one detail.");

    // Enter submits (Shift+Enter = newline)
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        form.requestSubmit();
      }
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (input.value||'').trim();
      if(!text) return;
      bubble('you', text);
      input.value='';

      try{
        if (window.compose) {
          const reply = await window.compose(text, man);
          if (reply) bubble('him', reply);
          return;
        }
      }catch(_){}

      const prompts = [
        "Mm. I can work with that—tell me a little more.",
        "Copy. Keep it clean or make it dirty—your lead.",
        "Good. Again—slowly. Paint the scene for me.",
        "Tell me “faster or slower,” I’ll tune to you."
      ];
      bubble('him', prompts[Math.floor(Math.random()*prompts.length)]);
    });

    // Keep auto-scroll if external scripts append
    new MutationObserver(()=>{ log.scrollTop = log.scrollHeight; })
      .observe(log, {childList:true});

    /* ---------- Stance (shows first) then Age (24h) ---------- */
    const STANCE_KEY='bb_stance_ok_at';
    const AGE_KEY='bb_age_ok_at';

    const stanceModal = document.getElementById('stanceModal');
    const sAgree = document.getElementById('sAgree');
    const stanceOk = document.getElementById('stanceOk');

    const ageModal = document.getElementById('ageModal');
    const g18 = document.getElementById('g18');
    const g988= document.getElementById('g988');
    const gateOk = document.getElementById('gateOk');

    function updateStance(){ stanceOk.disabled = !sAgree.checked; }
    sAgree.addEventListener('change', updateStance);

    function updateAge(){ gateOk.disabled = !(g18.checked && g988.checked); }
    g18.addEventListener('change', updateAge);
    g988.addEventListener('change', updateAge);

    function maybeShowAge(){
      try{
        const prev = +localStorage.getItem(AGE_KEY) || 0;
        const now = Date.now();
        if (now - prev > 24*60*60*1000) { // older than 24h
          ageModal.classList.add('on');
        }
      }catch(_){}
    }

    // open stance if not accepted (stores a long-lived flag, e.g. 180 days)
    (function initGates(){
      try{
        const stancePrev = +localStorage.getItem(STANCE_KEY) || 0;
        const now = Date.now();
        const ONE_EIGHTY_DAYS = 180*24*60*60*1000;
        if (now - stancePrev > ONE_EIGHTY_DAYS) {
          stanceModal.classList.add('on');
        } else {
          maybeShowAge();
        }
      }catch(_){
        // if storage fails, still show stance
        stanceModal.classList.add('on');
      }
    })();

    stanceOk.addEventListener('click', ()=>{
      try{ localStorage.setItem(STANCE_KEY, String(Date.now())); }catch(_){}
      stanceModal.classList.remove('on');
      // proceed to age check if needed
      maybeShowAge();
    });

    gateOk.addEventListener('click', ()=>{
      try{ localStorage.setItem(AGE_KEY, String(Date.now())); }catch(_){}
      ageModal.classList.remove('on');
    });
  </script>

  <!-- Keep your own chat logic if present -->
  <script src="/scripts/chat.js" defer></script>
</body>
</html>
