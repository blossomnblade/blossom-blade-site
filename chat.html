<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Blossom & Blade — Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0b0b0f; --panel:rgba(15,15,22,.72); --border:#ffffff1a; --fg:#f7f7fb; --accent:#ff2f86; }
    html,body{margin:0;padding:0;min-height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    header{position:relative;padding:18px 20px;display:flex;align-items:center;justify-content:center}
    header h1{margin:0;font-weight:800}
    .badge{position:absolute;right:16px;top:12px;font-size:12px;background:#111;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .stage{display:grid;place-items:center;padding:14px;background:linear-gradient(160deg,#11131a 0%,#0b0b0f 100%)}
    .chat-panel{width:min(1024px,94vw);height:min(70vh,74dvh);background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:18px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .msg{max-width:76%;margin:14px 0;padding:12px 16px;border-radius:12px;line-height:1.45}
    .msg-bot{background:#151520;border:1px solid var(--border)}
    .msg-user{margin-left:auto;background:var(--accent);color:#111;font-weight:700}
    .typing{opacity:.7;font-style:italic}
    .composer{display:flex;gap:12px;padding:14px;position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,11,15,0) 0%,rgba(11,11,15,.75) 30%,rgba(11,11,15,1) 100%)}
    #user-input{flex:1;padding:14px 16px;border-radius:999px;border:1px solid #fff2;background:#0e0e14;color:var(--fg);outline:none}
    #send-btn{padding:12px 18px;border-radius:16px;border:0;background:var(--accent);color:#111;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(255,47,134,.25)}
    @media (max-width:480px){.msg{max-width:88%}.chat-panel{height:60dvh}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Blossom & Blade — Chat</h1>
    <div class="badge">Adults 18+ only</div>
  </header>

  <main class="stage" id="stage">
    <div id="chat" class="chat-panel" aria-live="polite"></div>
  </main>

  <footer class="composer">
    <input id="user-input" type="text" placeholder="Say hi…" autocomplete="off"/>
    <button id="send-btn">Send</button>
  </footer>
</div>

<!-- Global prompts (no ES modules) -->
<script src="/scripts/prompts.js"></script>

<script>
/* ---------- BACKGROUND (never blank) ---------- */
(function(){
  function qs(n){ try{ return (new URLSearchParams(location.search)).get(n); }catch(e){ return null; } }
  var man = (qs('man')||qs('g')||'blade').toLowerCase();
  var sub = (qs('sub')||'day').toLowerCase();
  var override = qs('bg');
  var stage = document.getElementById('stage');

  var MAP = {
    blade:{day:'/images/blade-day.jpg',night:'/images/blade-night.jpg'},
    dylan:{day:'/images/dylan-day.jpg',night:'/images/dylan-night.jpg'},
    jesse:{day:'/images/jesse-day.jpg',night:'/images/jesse-bull-night.jpg'},
    alexander:{day:'/images/alexander-day.jpg',night:'/images/alexander-night.jpg'},
    silas:{day:'/images/silas-day.jpg',night:'/images/silas-night.jpg'},
    grayson:{day:'/images/grayson-day.jpg',night:'/images/grayson-night.jpg'}
  };
  var SUBF = {day:'/images/bg-day.jpg',night:'/images/bg-night.jpg'};
  var FALL = '/images/chat-bg-default.jpg';

  var guesses=[];
  if(override)guesses.push(override);
  if(MAP[man] && MAP[man][sub])guesses.push(MAP[man][sub]);
  guesses.push('/images/'+man+'-'+sub+'.jpg','/images/'+man+'.jpg');
  if(SUBF[sub])guesses.push(SUBF[sub]);
  guesses.push(FALL);

  function setBG(src){ stage.style.background="url('"+src+"') center/cover fixed no-repeat"; }
  (function next(i){
    if(i>=guesses.length) return;
    var src=guesses[i], img=new Image();
    img.onload=function(){ setBG(src); };
    img.onerror=function(){ next(i+1); };
    img.src=src;
  })(0);
})();

/* ---------- CHAT ENGINE (PG-13 brain + consent router) ---------- */
(function(){
  var chat = document.getElementById('chat');
  var input = document.getElementById('user-input');
  var sendBtn = document.getElementById('send-btn');

  function qs(n){ try{ return (new URLSearchParams(location.search)).get(n); }catch(e){ return null; } }
  var man = (qs('man')||qs('g')||'blade').toLowerCase();
  var persona = (window.VV_PROMPTS && window.VV_PROMPTS[man]) ? window.VV_PROMPTS[man] : window.VV_PROMPTS.blade;

  // session state
  var state = {
    turns:0, consent:false, name:null, spice:0, // 0=vanilla, 1=simmer, 2=steamy, 3=adult
    lastUser:"", facts:[], // short memory
  };

  function addMsg(who, text, cls){
    var row=document.createElement('div');
    row.className='msg msg-'+who+(cls?(' '+cls):'');
    row.textContent=text;
    chat.appendChild(row);
    chat.scrollTop=chat.scrollHeight;
    return row;
  }
  function typing(on){
    if(on){ return addMsg('bot','typing…','typing'); }
  }

  // opener once per man
  try{
    var key='vv_opened_'+man;
    if(!sessionStorage.getItem(key)){
      sessionStorage.setItem(key,'1');
      addMsg('bot', persona.openers[Math.floor(Math.random()*persona.openers.length)]);
    }
  }catch(e){ addMsg('bot', persona.openers[Math.floor(Math.random()*persona.openers.length)]); }

  // extract light facts (name, likes)
  function mineFacts(t){
    var m = t.match(/\b(i['’]?m|i am|my name is)\s+([A-Za-z]{2,20})/i);
    if(m){ state.name = m[2]; }
    var like = t.match(/\b(i like|i love)\s+([^\.!]{2,40})/i);
    if(like){ state.facts.push('likes: '+like[2].trim()); if(state.facts.length>5)state.facts.shift(); }
  }

  // consent ladder
  var CONSENT_ON = [/i consent/i,/yes we can/i,/turn up the heat/i,/go further/i,/steamier/i];
  function detectConsent(t){ for(var i=0;i<CONSENT_ON.length;i++){ if(CONSENT_ON[i].test(t)) return true; } return false; }

  async function planAndReply(userText){
    state.turns++; state.lastUser=userText;
    mineFacts(userText);
    if(detectConsent(userText)) state.consent=true;

    // decide spice target
    if(state.turns<4) state.spice=0;
    else if(state.turns<10) state.spice=1;
    else if(state.turns>=10 && state.consent) state.spice=2;

    // route: adult after explicit consent & long enough chat
    var useAdult = (state.consent && state.turns>=12 && window.ADULT_ROUTE_ENABLED);

    var t = typing(true);

    try{
      var payload = {
        man,
        persona: persona.core,
        guardrails: persona.guardrails,
        memory: {
          name: state.name, facts: state.facts.slice(-5),
          consent: state.consent, spice: state.spice
        },
        history: takeHistory(10),
        user: userText,
        mode: useAdult ? "adult" : "sfw"
      };
      var res = await fetch(useAdult?"/api/adult-chat":"/api/chat",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      var data = await res.json();
      t.remove();
      addMsg('bot', data.reply || "Let’s keep it kind and on your terms. Tell me what you want to talk about.");
    }catch(e){
      try{ t.remove(); }catch(_){}
      addMsg('bot',"I’m here. Tell me something small from your day while I gather my thoughts.");
    }
  }

  // minimal history capture (text only, short)
  var trail=[];
  function pushTrail(role,content){
    trail.push({role,content});
    if(trail.length>40) trail.shift();
  }
  function takeHistory(n){ return trail.slice(-n); }

  // wire UI
  function send(){
    var txt=(input.value||"").trim();
    if(!txt) return;
    addMsg('user',txt); pushTrail('user',txt); input.value="";
    planAndReply(txt).then(()=>{}); // fire and forget
  }
  sendBtn.onclick = send;
  input.addEventListener('keydown',function(e){ if(e.key==='Enter'){ e.preventDefault(); send(); } });

  // seed trail with opener
  pushTrail('system', persona.systemSeed);
})();
</script>
</body>
</html>
