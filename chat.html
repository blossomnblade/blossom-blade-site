<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chat • Blossom &amp; Blade</title>
<style>
  :root{
    --bg:#0e0f14; --panel:#141826; --ring:#242a40; --ink:#eef0f7; --muted:#a5a7b7;
    --accent:#b86adf; --accent2:#6ac2df; --warn:#ffb86b; --bad:#e47777; --ok:#2fb872;
  }
  *{box-sizing:border-box}
  body{margin:0;background:
    radial-gradient(1200px 600px at 50% -240px, rgba(255,255,255,.05), transparent 60%),
    var(--bg); color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;max-width:980px;margin:0 auto}
  .pill{border:1px solid var(--ring);border-radius:999px;padding:6px 10px;color:#dfe3f2;background:#0f1221}
  .wrap{max-width:980px;margin:0 auto;padding:12px 16px 36px}
  h2{margin:8px 0 4px;font-size:18px;opacity:.95}
  .bar{height:6px;background:#262b42;border-radius:999px;overflow:hidden;margin:6px 0 14px}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg, var(--accent), var(--accent2))}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.04)), var(--panel);
         border:1px solid var(--ring);border-radius:16px;padding:14px 14px 10px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .feed{max-height:58vh;overflow:auto;padding:10px 6px}
  .row{display:block;margin:10px 0;max-width:86%}
  .row.you{margin-left:auto}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px}
  .bubble.them{background:#0f1221;border:1px solid var(--ring)}
  .bubble.you{background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#111}
  .input{display:flex;gap:8px;margin-top:12px}
  input[type=text]{flex:1;background:#0f1221;border:1px solid var(--ring);border-radius:12px;color:#dfe3f2;padding:12px 14px}
  button{border:0;border-radius:999px;padding:12px 16px;font-weight:800;cursor:pointer}
  .send{background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#12081a}
  .fineprint{margin-top:10px;color:var(--muted);font-size:12px;text-align:center}
  /* modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
  .sheet{width:min(620px,92vw);background:#121526;border:1px solid var(--ring);border-radius:16px;padding:18px 18px 14px}
  .sheet h3{margin:0 0 8px}
  .list{color:#cfd2e6;font-size:14px}
  .list li{margin:6px 0}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{background:#0f1221;border:1px solid var(--ring);color:#eaeefb;padding:10px 14px;border-radius:999px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#12081a;font-weight:800}
  .hidden{display:none}
</style>
</head>
<body>
  <header>
    <div><strong>Blossom &amp; Blade</strong></div>
    <div class="pill" id="trialPill">Trial: <span id="trialTime">3:30</span></div>
  </header>

  <div class="wrap">
    <h2 id="guyName">…</h2>
    <div class="bar"><i id="barFill"></i></div>

    <div class="panel">
      <div id="feed" class="feed"></div>
      <div class="input">
        <input id="input" type="text" placeholder="Say hi…" autocomplete="off"/>
        <button id="send" class="send">Send</button>
      </div>
      <div class="fineprint">Site stays PG-13. We follow your lead, but within Community Standards.</div>
    </div>
  </div>

  <!-- Community Standards Modal -->
  <div id="stdModal" class="modal">
    <div class="sheet">
      <h3>Community Standards</h3>
      <p class="muted">We keep chat adult &amp; consensual. PG-13 by default. No visuals—words only.</p>
      <ul class="list">
        <li>No minors/“school boy or girl”/“barely legal”/teen/high-school contexts</li>
        <li>No incest/step-family, non-consent/rape/coercion, or intoxication without capacity</li>
        <li>No bestiality/necrophilia, trafficking, extreme bodily fluids, blood/knife “play”</li>
        <li>No hate slurs or targeted harassment</li>
      </ul>
      <p id="stdNote" class="muted hidden" style="margin-top:8px"></p>
      <div class="actions">
        <button id="stdOk" class="btn primary">Okay — keep it PG-13</button>
        <button id="stdFull" class="btn">View full standards</button>
        <button id="stdBlock" class="btn">Block this device</button>
        <button id="stdReport" class="btn">Report</button>
      </div>
    </div>
  </div>

  <!-- Preview-limit Modal -->
  <div id="paywall" class="modal">
    <div class="sheet">
      <h3>Free previews used up</h3>
      <p class="muted" id="previewText">You’ve had 3 previews.</p>
      <div class="actions">
        <a class="btn primary" id="goDay">Day Pass — $5.99</a>
        <a class="btn primary" id="goMonth">Monthly — $10.99</a>
        <button class="btn" id="oneMore">Another 3½-minute preview</button>
        <button class="btn" id="later">Maybe later (1 minute)</button>
      </div>
    </div>
  </div>

<script>
/* ----------------- tiny data ----------------- */
const GUYS = {
  blade: {name:'Blade Kincaid', vibe:'dark manor'},
  grayson: {name:'Grayson Kincaid', vibe:'penthouse glow'},
  alexander: {name:'Alexander Jackson', vibe:'boardroom'},
  dylan: {name:'Dylan Vale', vibe:'neon garage'},
  jesse: {name:'Jesse Granger', vibe:'bonfire & boots'},
  silas: {name:'Silas Lennox', vibe:'gothic library'}
};

const GREET = {
  blade: [
    "Footsteps behind you… I keep pace.",
    "Found you, brave girl. Don’t run—yet.",
    "Doorway or shadows? I’m close behind.",
    "I catch you easy or should I give you a head start?",
    "I like when you look back. Want me closer?",
    "Pick: gentle questions or a little chase?"
  ],
  grayson: [
    "One detail at a time. What should I notice first?",
    "Voice low: tell me your mood in five words.",
    "Calm or direction—what do you want from me?",
    "I’m listening. Where does it land—heart or head?",
    "Let’s set the room: lights low or city view?",
    "What kind of attention feels good tonight?"
  ],
  alexander: [
    "Shoes off. I’m leading. Lights low or city view while we talk?",
    "Short answers from now on. What do you want me to notice first?",
    "Desk or window seat? Decide.",
    "I appreciate initiative. What’s your ideal way to unwind?",
    "Keep it sharp—list two things you want from me.",
    "Tell me your favorite kind of trouble."
  ],
  dylan: [
    "Hands flat on the counter, pretty thing. Calm tune-up or teasing tune-up?",
    "Say less, feel more. Where do you want focus first?",
    "Slow ride or quick detour?",
    "You like honest fixes—what needs attention?",
    "I’ve got tools and time. What’s your request?",
    "Signal me with one word right now."
  ],
  jesse: [
    "Darlin’, park it. Sweet or rowdy tonight?",
    "Truth first—what’d the day do to you?",
    "Cozy porch talk or truck bed under the stars?",
    "Want me gentle or a touch mean in the best way?",
    "You pick the music, I set the pace. Deal?",
    "Tell me one thing you’re craving—plain talk."
  ],
  silas: [
    "Come closer, muse. Soft, or a little rough on the edges?",
    "Lend me a verse—five words to paint you.",
    "Tilt your chin up—what should I study first?",
    "Say your name slow; I’ll keep it safe.",
    "What color is tonight for you?",
    "I’ll match your rhythm—lead a step."
  ]
};

// basic random helper
const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];

/* ----------------- boot ----------------- */
const qs = new URLSearchParams(location.search);
const man = (qs.get('man') || 'blade').toLowerCase();
const guy = GUYS[man] || GUYS.blade;
document.getElementById('guyName').textContent = guy.name;

const feed = document.getElementById('feed');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');

function row(html, who='them'){
  const r = document.createElement('div');
  r.className = `row ${who==='you'?'you':''}`;
  const b = document.createElement('div');
  b.className = `bubble ${who==='you'?'you':'them'}`;
  b.innerHTML = html;
  r.appendChild(b);
  feed.appendChild(r);
  feed.scrollTop = feed.scrollHeight;
}

function escapeHtml(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* -------------- trial timer (3½ min), 3 previews -------------- */
let secs = 210; // 3.5 min
let interval = null;
const bar = document.getElementById('barFill');
const pill = document.getElementById('trialTime');

function fmt(n){ const m=Math.floor(n/60), s=n%60; return `${m}:${String(s).padStart(2,'0')}`; }

function startTimer(){
  pill.textContent = fmt(secs);
  bar.style.width = `${(210-secs)/210*100}%`;
  interval = setInterval(()=>{
    secs--; if (secs<0){ clearInterval(interval); openPaywall(); return; }
    pill.textContent = fmt(secs);
    bar.style.width = `${(210-secs)/210*100}%`;
  },1000);
}

function openPaywall(){
  const used = Number(localStorage.getItem(`bb.trials.${man}`) || 0);
  const modal = document.getElementById('paywall');
  document.getElementById('previewText').textContent =
    used>=3 ? `You’ve had ${used} previews with ${guy.name}.` : `Trial ended.`;
  modal.style.display = 'grid';
}
document.getElementById('oneMore').onclick = () => {
  let used = Number(localStorage.getItem(`bb.trials.${man}`) || 0);
  if (used < 3) { localStorage.setItem(`bb.trials.${man}`, String(used+1)); }
  document.getElementById('paywall').style.display = 'none';
  secs = 210; clearInterval(interval); startTimer();
};
document.getElementById('later').onclick = () => { document.getElementById('paywall').style.display='none'; };
document.getElementById('goDay').onclick   = () => location.href = `pay.html?man=${encodeURIComponent(man)}&plan=day`;
document.getElementById('goMonth').onclick = () => location.href = `pay.html?man=${encodeURIComponent(man)}&plan=month`;

/* -------------- standards & blocking (hard lines only) -------------- */
// returns a string reason if disallowed, else ''
function hardBan(text){
  const s = text.toLowerCase();

  // minors / teen / school contexts
  if (/\b(minor|kid|teen|under\s*age|barely\s*legal|high\s*school|school\s*(boy|girl))\b/.test(s)) return 'Minors / teen / high-school contexts are not allowed.';

  // incest / step family
  if (/\b(incest|step\s*(mom|mother|dad|father|bro|brother|sis|sister)|my\s*(mom|mother|dad|father|brother|sister))\b/.test(s)) return 'Incest / step-family not allowed.';

  // non-consent / rape / kidnapping / choking to harm
  if (/\b(rape|raping|non[-\s]*consent|no\s*consent|kidnap|kidnapping|abduct|force\s*me|forced\s*sex|choke\s*me\s*(out)?|strangle|asphyx)/.test(s))
    return 'Non-consent, kidnapping, or dangerous harm is not allowed.';

  // intoxication without capacity
  if (/\b(blackout|passed\s*out|roofie|drug\s*me|too\s*drunk\s*to|unconscious)\b/.test(s)) return 'Intoxication without capacity is not allowed.';

  // bestiality / necrophilia
  if (/\b(bestiality|animal\s*sex|necro(?:philia)?)\b/.test(s)) return 'Not allowed.';

  // extreme bodily fluids / blood / knife play
  if (/\b(fecal|scat|shit\s*(play)?|urine|pee\s*(play)?|blood\s*(play)?|knife\s*(play)?)\b/.test(s)) return 'Not allowed.';

  // hate slurs or targeted harassment (short, conservative list)
  if (/\b(kike|faggot|retard|tranny|chink|spic|raghead)\b/.test(s)) return 'Hate slurs / targeted harassment not allowed.';

  return '';
}

function showStandards(reason){
  const blockedUntil = localStorage.getItem('bb.blockedUntil');
  if (blockedUntil && Date.now() < Number(blockedUntil)) {
    alert('This device is temporarily blocked for Community Standards violations.');
    return true;
  }
  const modal = document.getElementById('stdModal');
  const note  = document.getElementById('stdNote');
  if (reason){ note.textContent = "We didn’t send that last message: " + reason; note.classList.remove('hidden'); }
  else { note.classList.add('hidden'); }
  modal.style.display = 'grid';
  return true;
}
document.getElementById('stdOk').onclick = ()=>{ document.getElementById('stdModal').style.display='none'; };
document.getElementById('stdFull').onclick = ()=>{ alert('Full Standards are shown on the site footer / policy page.'); };
document.getElementById('stdBlock').onclick = ()=>{
  const until = Date.now() + 30*24*60*60*1000; // 30 days
  localStorage.setItem('bb.blockedUntil', String(until));
  alert('This device is now blocked for 30 days.');
  document.getElementById('stdModal').style.display='none';
};
document.getElementById('stdReport').onclick = ()=>{ alert('Thanks. We’ve noted this session.'); };

/* -------------- send / receive -------------- */
let history = []; // {role:'user'|'assistant', content:'...'}

function greet(){
  // rotate greetings: one on load, then swap after ~5 user lines
  const line = pick(GREET[man] || GREET.blade);
  row(`<strong>${guy.name}:</strong> ${escapeHtml(line)}`);
}
greet();
startTimer();

async function talk(text){
  // push user row
  row(escapeHtml(text), 'you');

  // call backend
  try{
    const r = await fetch(`/api/chat`, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        man, text, history
      })
    });
    if (!r.ok) throw new Error('bad status');
    const data = await r.json();
    const reply = (data && data.reply) ? data.reply : "…";
    history.push({role:'user', content:text});
    history.push({role:'assistant', content:reply});
    row(`<strong>${guy.name}:</strong> ${escapeHtml(reply)}`);
  }catch(e){
    row(`Network hiccup. Give me one more line and I’m right here.`, 'them');
  }
}

function blocked(){ 
  const until = localStorage.getItem('bb.blockedUntil');
  return until && Date.now() < Number(until);
}

function onSend(){
  if (blocked()){ showStandards(); return; }
  const v = input.value.trim(); if (!v) return;
  input.value = '';

  // Hard-line standards (minimal list, not overly sensitive)
  const reason = hardBan(v);
  if (reason){
    // increment warnings
    const k = 'bb.warns'; const n = Number(localStorage.getItem(k) || 0) + 1;
    localStorage.setItem(k, String(n));
    if (n >= 3) { localStorage.setItem('bb.blockedUntil', String(Date.now()+30*24*60*60*1000)); }
    showStandards(reason);
    return;
  }

  talk(v);
}

sendBtn.addEventListener('click', onSend);
input.addEventListener('keydown', e => { if (e.key==='Enter'){ e.preventDefault(); onSend(); }});
</script>
</body>
</html>
