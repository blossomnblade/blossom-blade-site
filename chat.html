<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Blossom & Blade â€” Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0b0b0f; --panel:rgba(15,15,22,.72); --border:#ffffff1a; --fg:#f7f7fb; --accent:#ff2f86; }
    html,body{margin:0;padding:0;min-height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    header{position:relative;padding:18px 20px;display:flex;align-items:center;justify-content:center}
    header h1{margin:0;font-weight:800}
    .badge{position:absolute;right:16px;top:12px;font-size:12px;background:#111;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .stage{display:grid;place-items:center;padding:14px;background:linear-gradient(160deg,#11131a 0%,#0b0b0f 100%)}
    .chat-panel{width:min(1024px,94vw);height:min(70vh,74dvh);background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:18px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .msg{max-width:76%;margin:14px 0;padding:12px 16px;border-radius:12px;line-height:1.45}
    .msg-bot{background:#151520;border:1px solid var(--border)}
    .msg-user{margin-left:auto;background:var(--accent);color:#111;font-weight:700}
    .typing{opacity:.7;font-style:italic}
    .composer{display:flex;gap:12px;padding:14px;position:sticky;bottom:0;background:linear-gradient(180deg,rgba(11,11,15,0) 0%,rgba(11,11,15,.75) 30%,rgba(11,11,15,1) 100%)}
    #user-input{flex:1;padding:14px 16px;border-radius:999px;border:1px solid #fff2;background:#0e0e14;color:#f7f7fb;outline:none}
    #send-btn{padding:12px 18px;border-radius:16px;border:0;background:var(--accent);color:#111;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(255,47,134,.25)}
    @media (max-width:480px){.msg{max-width:88%}.chat-panel{height:60dvh}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Blossom & Blade â€” Chat</h1>
    <div class="badge">Adults 18+ only</div>
  </header>

  <main class="stage" id="stage">
    <div id="chat" class="chat-panel" aria-live="polite"></div>
  </main>

  <footer class="composer">
    <input id="user-input" type="text" placeholder="Say hiâ€¦" autocomplete="off"/>
    <button id="send-btn">Send</button>
  </footer>
</div>

<script>
/* ---------------- BACKGROUND (matches YOUR filenames) ---------------- */
(function(){
  function qs(n){ try{ return (new URLSearchParams(location.search)).get(n); }catch(e){ return null; } }
  var man=(qs('man')||qs('g')||'blade').toLowerCase();
  var sub=(qs('sub')||'night').toLowerCase();
  var stage=document.getElementById('stage');

  var MAP={
    blade:     { day:'/images/blade-woods.jpg',            night:'/images/blade-woods.jpg' },
    dylan:     { day:'/images/dylan-garage.jpg',           night:'/images/dylan-garage.jpg' },
    jesse:     { day:'/images/jesse-books-day.jpg',        night:'/images/jesse-bull-night.jpg' },
    alexander: { day:'/images/bg_alexander_boardroom.jpg', night:'/images/bg_alexander_boardroom.jpg' },
    silas:     { day:'/images/bg_silas_stage.jpg',         night:'/images/bg_silas_stage.jpg' },
    grayson:   { day:'/images/grayson-bg.jpg',             night:'/images/grayson-bg.jpg' }
  };
  var SUBF   ={ day:'/images/bg_dark_romance.jpg', night:'/images/gothic-bg.jpg' };
  var GLOBAL ='/images/gothic-bg.jpg';

  var guesses=[];
  if(MAP[man] && MAP[man][sub]) guesses.push(MAP[man][sub]);
  guesses.push('/images/'+man+'-'+sub+'.jpg','/images/'+man+'.jpg');
  if(SUBF[sub]) guesses.push(SUBF[sub]);
  guesses.push(GLOBAL);

  function setBG(src){ stage.style.background="url('"+src+"') center/cover fixed no-repeat"; }
  (function next(i){
    if(i>=guesses.length) return;
    var src=guesses[i], img=new Image();
    img.onload=function(){ setBG(src); };
    img.onerror=function(){ next(i+1); };
    img.src=src;
  })(0);
})();

/* ---------------- CHAT (self-contained; Enter + Button work) ---------------- */
(function(){
  var chat  = document.getElementById('chat');
  var input = document.getElementById('user-input');
  var send  = document.getElementById('send-btn');

  function addMsg(who, text, cls){
    var row=document.createElement('div');
    row.className='msg msg-'+who+(cls?(' '+cls):'');
    row.textContent=text;
    chat.appendChild(row);
    chat.scrollTop=chat.scrollHeight;
    return row;
  }
  function typing(){ return addMsg('bot','typingâ€¦','typing'); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function qs(n){ try{ return (new URLSearchParams(location.search)).get(n); }catch(e){ return null; } }
  var man=(qs('man')||qs('g')||'blade').toLowerCase();

  // Warm opener (no external files)
  var OPENERS=[
    "You found me. I was hoping you would.",
    "I kept a seat warm for you. Come closer.",
    "Late nights suit you. Tell me one tiny win from today."
  ];
  try{
    var key='vv_opened_'+man;
    if(!sessionStorage.getItem(key)){ sessionStorage.setItem(key,'1'); addMsg('bot', pick(OPENERS)); }
  }catch(e){ addMsg('bot', pick(OPENERS)); }

  // Minimal memory + consent
  var state={turns:0, consent:false, name:null, facts:[], history:[]};
  var CONSENT_ON=[/i consent/i,/turn up the heat/i,/go further/i,/steamier/i,/spicier/i,/ok escalate/i];

  function push(role,content){ state.history.push({role:role,content:content}); if(state.history.length>40) state.history.shift(); }
  function mineFacts(t){
    var m=t.match(/\b(i['â€™]?m|i am|my name is)\s+([A-Za-z]{2,20})/i); if(m) state.name=m[2];
    var like=t.match(/\b(i like|i love)\s+([^\.!]{2,40})/i); if(like){ state.facts.push(like[2].trim()); if(state.facts.length>5) state.facts.shift(); }
  }

  function localFallback(userText){
    var a=["I hear you: "+userText,"That hits all the right buttons.","Say moreâ€”Iâ€™m listening."];
    var b=["Sweet or wicked tonight?","Do you like gentle praise or playful command?","Where should I startâ€”words in your ear, or fingers laced with yours?"];
    return pick(a)+" "+pick(b);
  }

  async function planAndReply(userText){
    state.turns++; mineFacts(userText);
    if (CONSENT_ON.some(function(r){ return r.test(userText);} )) state.consent=true;

    var useAdult = false; // flip via API/adult later if you want

    var t=typing();
    try{
      var payload={
        man: man,
        persona: {name: man},
        guardrails:{},
        memory:{name:state.name,facts:state.facts,consent:state.consent},
        history: state.history.slice(-12),
        user: userText,
        mode: useAdult?"adult":"sfw"
      };
      var res=await fetch(useAdult?"/api/adult-chat":"/api/chat",{
        method:"POST",headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      var data=await res.json();
      if(t && t.parentNode) t.parentNode.removeChild(t);
      var reply=(data && data.reply)?data.reply:localFallback(userText);
      addMsg('bot',reply); push('assistant',reply);
    }catch(e){
      if(t && t.parentNode) t.parentNode.removeChild(t);
      var soft=localFallback(userText);
      addMsg('bot',soft); push('assistant',soft);
    }
  }

  function doSend(){
    var txt=(input.value||"").trim();
    if(!txt) return;
    addMsg('user',txt); push('user',txt);
    input.value="";
    planAndReply(txt);
  }

  // ðŸ”§ This is the bit that was broken before â€” now itâ€™s inline and guaranteed to bind.
  send.onclick = doSend;
  input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); doSend(); } });

  // seed system
  push('system',"Warm, human, flirty, consent-first. Keep it PG-13 here. Short replies with one follow-up question.");
})();
</script>
</body>
</html>
