<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat • Blossom & Blade</title>
<style>
  :root{
    --bg:#0e0b12; --panel:#171320; --edge:#2a2336;
    --ink:#e9e7ef; --muted:#b9b2c7; --accent:#c05acb; --accent-2:#8b5cf6;
    --danger:#ff5470; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 700px at 50% -10%, #1a1423 10%, var(--bg) 70%), url('/images/gothic-bg.jpg') center/cover fixed no-repeat;
    color:var(--ink); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    min-height:100vh;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,0));
    position:sticky; top:0; z-index:10; backdrop-filter: blur(4px);
    border-bottom:1px solid rgba(255,255,255,.05);
  }
  header .title{font-weight:700; letter-spacing:.3px}
  header .right{display:flex; gap:14px; align-items:center}
  a, a:visited{color:var(--muted); text-decoration:none}
  a:hover{color:var(--ink)}
  .wrap{max-width:980px; margin:0 auto; padding:10px 14px 60px}
  .namebar{font-weight:700; margin:4px 0 8px; opacity:.9}
  .trial{height:6px; background:#2b2237; border-radius:8px; overflow:hidden}
  .trial > div{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width .2s}

  .board{
    background:rgba(16,12,24,.82); border:1px solid var(--edge); border-radius:16px;
    box-shadow:0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    margin-top:14px; padding:14px; min-height:56vh; display:flex; flex-direction:column; gap:10px;
  }
  .row{display:flex; width:100%}
  .ai, .me{
    max-width:72%; padding:10px 12px; border-radius:14px; position:relative;
    border:1px solid rgba(255,255,255,.06);
  }
  .ai{background:#1b1626}
  .me{margin-left:auto; background:#2a1d33; color:#efe9ff}
  .sys{color:var(--muted)}
  .composer{display:flex; gap:8px; margin-top:10px}
  input[type=text]{
    flex:1; padding:12px 14px; background:#140f1b; border:1px solid var(--edge); border-radius:12px; color:var(--ink);
    outline:none
  }
  button.btn{
    padding:12px 16px; border:0; border-radius:12px; color:#fff; background:linear-gradient(180deg,var(--accent),#8b3aa3);
    cursor:pointer; font-weight:700;
  }
  button.btn:disabled{opacity:.5; cursor:not-allowed}

  .footnote{margin-top:6px; text-align:center; color:var(--muted); font-size:12px}

  /* Standards modal (appears on first explicit attempt or on violations) */
  .overlay{
    position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:40;
  }
  .panel{
    width:min(640px,92vw); background:#1b1626; border:1px solid var(--edge); border-radius:18px; padding:18px;
    box-shadow:0 10px 40px rgba(0,0,0,.6)
  }
  .panel .hd{font-weight:800; margin-bottom:6px}
  .choices{display:flex; gap:10px; flex-wrap:wrap}
  .btn.ghost{background:#241a2d}
  .btn.gray{background:#2a1a25}

  /* Free previews used up */
  .overlay .subtle{color:var(--muted); font-size:14px}

  /* tiny toast */
  #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#241a2d; color:var(--ink); border:1px solid var(--edge); padding:10px 14px; border-radius:12px; display:none; z-index:60}
</style>
</head>
<body>
  <header>
    <div class="title">Blossom & Blade</div>
    <div class="right">
      <a id="pricing" href="/pay.html">Pricing</a>
    </div>
  </header>

  <div class="wrap">
    <div id="manName" class="namebar">…</div>
    <div class="trial"><div id="trialBar"></div></div>

    <div class="board" id="board">
      <div id="log"></div>

      <div class="composer">
        <input id="msg" type="text" placeholder="Say hi…" autocomplete="off" />
        <button class="btn" id="send">Send</button>
      </div>
      <div class="footnote">Site stays PG-13. We follow your lead, but within Community Standards.</div>
    </div>
  </div>

  <!-- Standards (educational or violation). We can show without a strike on first explicit. -->
  <div id="stdOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Community Standards">
    <div class="panel">
      <div class="hd"><strong>Community Standards</strong></div>
      <div class="bd">
        <p id="stdIntro" class="subtle">We keep chat adult & consensual, PG-13 by default. No visuals—words only.</p>
        <ul class="subtle" style="margin:10px 0 10px 18px">
          <li>No minors/“school boy or girl”/“barely legal”/teen or high-school contexts</li>
          <li>No incest/step-family, non-consent/coercion, or intoxication without capacity</li>
          <li>No bestiality/necrophilia, trafficking, extreme bodily fluids, blood/knife “play”</li>
          <li>No hate slurs or targeted harassment</li>
        </ul>
        <p id="stdStrike" class="subtle" style="margin-top:6px"></p>
        <div class="choices" style="margin-top:10px">
          <button id="stdContinue" class="btn">Okay — keep it PG-13</button>
          <a class="btn gray" href="/standards.html" target="_blank">View full standards</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Free previews used up -->
  <div id="noPreview" class="overlay">
    <div class="panel">
      <div class="hd">Free previews used up</div>
      <p class="subtle">You’ve had 3 previews with <span id="npGuy"></span>.</p>
      <p>Grab a Day Pass or go Monthly to keep chatting.</p>
      <div class="choices">
        <a id="npDay" class="btn">Day Pass — $5.99</a>
        <a id="npMonth" class="btn">Monthly — $10.99</a>
        <button id="npAnother" class="btn ghost">Another 3½-minute preview</button>
        <button id="npMaybe" class="btn gray">Maybe later (1 minute)</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
/* -------------------- Setup & helpers -------------------- */
const $ = sel => document.querySelector(sel);
const log = $("#log");
const input = $("#msg");
const sendBtn = $("#send");
const trialBar = $("#trialBar");

/* Robust “who is this guy” detection */
const SLUGS = ["blade","grayson","dylan","silas","alexander","jesse"];
function detectMan(){
  const q = new URLSearchParams(location.search);
  let m = (q.get("man") || "").toLowerCase();
  if (SLUGS.includes(m)) return m;
  try{
    const ref = new URL(document.referrer);
    const rm = (new URLSearchParams(ref.search).get("man") || "").toLowerCase();
    if (SLUGS.includes(rm)) return rm;
    const p = ref.pathname.toLowerCase();
    for (const s of SLUGS){
      if (p.includes(`/rooms/${s}.html`) || p.endsWith(`/${s}.html`) || p.endsWith(`/${s}`)) return s;
    }
  }catch{}
  const stored = (localStorage.getItem("lastMan") || "").toLowerCase();
  if (SLUGS.includes(stored)) return stored;
  return "blade";
}
const manParam = detectMan();
localStorage.setItem("lastMan", manParam);

const GUYS = {
  blade:     { name:"Blade Kincaid", bg:"/images/blade-woods.jpg" },
  grayson:   { name:"Grayson Kincaid", bg:"/images/grayson-bg.jpg" },
  dylan:     { name:"Dylan Vale", bg:"/images/dylan-garage.jpg" },
  silas:     { name:"Silas Lennox", bg:"/images/gothic-bg.jpg" },
  alexander: { name:"Alexander Jackson", bg:"/images/gothic-bg.jpg" },
  jesse:     { name:"Jesse Granger", bg:"/images/gothic-bg.jpg" },
};
const guy = GUYS[manParam] || GUYS.blade;

document.body.style.backgroundImage = `radial-gradient(1200px 700px at 50% -10%, #1a1423 10%, var(--bg) 70%), url('${guy.bg}')`;
$("#manName").textContent = guy.name;
$("#pricing").href = `/pay.html?man=${encodeURIComponent(manParam)}`;

function row(html, who="ai"){
  const r = document.createElement("div");
  r.className = "row";
  const b = document.createElement("div");
  b.className = who === "me" ? "me" : "ai";
  b.innerHTML = html;
  r.appendChild(b);
  log.appendChild(r);
  log.parentElement.scrollTop = log.parentElement.scrollHeight;
}
function toast(t){ const el=$("#toast"); el.textContent=t; el.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>el.style.display="none", 1600); }

/* -------------------- Preview timer & gating -------------------- */
const PREVIEW_SEC = 210; // 3.5 minutes
let remaining = PREVIEW_SEC, tHandle=null;

const PREV_KEY="bb.previews"; // map {man:count}
function getPrevCount(){ try {return JSON.parse(localStorage.getItem(PREV_KEY)||"{}")[manParam]||0;} catch(e){return 0;} }
function bumpPrevCount(){
  const map = (()=>{ try {return JSON.parse(localStorage.getItem(PREV_KEY)||"{}");} catch(e){return {}} })();
  map[manParam]=(map[manParam]||0)+1; localStorage.setItem(PREV_KEY, JSON.stringify(map));
}

function startTimer(){
  clearInterval(tHandle);
  remaining = PREVIEW_SEC;
  tHandle = setInterval(()=>{
    remaining--; const pct = ((PREVIEW_SEC-remaining)/PREVIEW_SEC)*100; trialBar.style.width = pct+"%";
    if (remaining<=0){ clearInterval(tHandle); endPreview(); }
  }, 1000);
}
function endPreview(){
  bumpPrevCount();
  $("#npGuy").textContent=guy.name;
  $("#noPreview").style.display="grid";
}

/* overlay actions */
$("#npDay").onclick = ()=> location.href=`/pay.html?man=${encodeURIComponent(manParam)}&plan=day`;
$("#npMonth").onclick = ()=> location.href=`/pay.html?man=${encodeURIComponent(manParam)}&plan=month`;
$("#npAnother").onclick = ()=>{ $("#noPreview").style.display="none"; startTimer(); };
$("#npMaybe").onclick = ()=>{ $("#noPreview").style.display="none"; remaining = 60; startTimer(); };

/* -------------------- Community Standards (push from the start) -------------------- */
const stdOverlay = $("#stdOverlay");
const stdContinue = $("#stdContinue");
const STRIKES_KEY = "bb.stdStrikes";
const MAX_STRIKES = 3;
let eduShown = false; // show educational modal once when user tries explicit (no strike)

function getStrikes(){ return Number(localStorage.getItem(STRIKES_KEY) || 0); }
function setStrikes(n){ localStorage.setItem(STRIKES_KEY, String(n)); }

function norm(input){
  let s = (input||"").toLowerCase();
  s = s.replace(/[@]/g,"a").replace(/[4]/g,"a").replace(/[1!|]/g,"i").replace(/[3]/g,"e").replace(/[0]/g,"o").replace(/[$]/g,"s");
  s = s.replace(/([a-z])\1{2,}/g,"$1$1").replace(/\s+/g," ").trim();
  return s;
}

/* Hard bans: instant strike + modal (counts toward block) */
const DISALLOWED_ALWAYS = [
  /\b(minor|under\s*age|under\s*1[0-9]|under\s*18|pre[-\s]?teen|jail\s*bait|barely\s*legal|teen\s*(?:sex|play)?)\b/i,
  /\bincest\b/i, /\bstep(?:-|\s)?(?:mom|mother|dad|father|bro(?:ther)?|sis(?:ter)?)\b/i,
  /\brape\b/i, /\bnon[-\s]?consent(?:ual)?\b/i, /\bcoerc(?:e|ion)\b/i, /\bagainst\s+my\s+will\b/i,
  /\b(drugged|chloroform|black\s*out|passed\s*out|unconscious)\b/i, /\basleep\s*(?:sex|play)\b/i,
  /\b(bestial(?:ity)?|zoophil(?:e|ia)|animal\s*sex)\b/i, /\b(necrophil(?:e|ia)|corpse\s*(?:sex|play))\b/i,
  /\bsex\s*traffick(?:ing)?\b/i,
  /\b(scat|feces|coprophag(?:y|ia))\b/i, /\b(piss|urinate)\s*on\b/i, /\bblood\s*play\b/i, /\bknife\s*play\b/i,
  // hate slurs (short list; expand if needed)
  /\b(?:n[i1]gg(?:a|er)s?)\b/i, /\b(?:f[a@]gg?(?:o|0)t[s]?)\b/i, /\b(?:tr[a@]nn?y)\b/i, /\b(?:k[i1]k[e3]s?)\b/i
];

/* “Explicit but not banned” — educational modal only, no strike */
const EXPLICIT_BUT_ALLOWED = /\b(fuck|cock|dick|pussy|cum|orgasm|deep\s*throat|blow\s*job|doggystyle|bend\s*me|rail|ride|spank|choke|thrust|go\s*down|eat\s*out)\b/i;

function showStandards({strike=false}={}) {
  const strikes = getStrikes();
  if (strike){
    const n = strikes + 1; setStrikes(n);
    $("#stdStrike").textContent = (n >= MAX_STRIKES)
      ? `Standards warning ${n} of ${MAX_STRIKES}. This device is now blocked for 30 days.`
      : `Standards warning ${n} of ${MAX_STRIKES}. Three warnings results in a 30-day block.`;
  } else {
    $("#stdStrike").textContent = "No strike — just a reminder: we keep it PG-13 here.";
  }
  stdOverlay.style.display = "grid";
  pauseTimer();
}

function hideStandards(){ stdOverlay.style.display = "none"; resumeTimer(); }
stdContinue.onclick = hideStandards;

/* Device block after 3 strikes */
(function(){
  const until = Number(localStorage.getItem("bb.blockedUntil")||0);
  if (until && Date.now() < until){
    const days = Math.ceil((until - Date.now())/86400000);
    row(`<em class="sys">This device is blocked for ${days} day(s) due to repeated standards violations.</em>`);
    input.disabled = true; sendBtn.disabled = true;
  }
})();

/* -------------------- Greetings -------------------- */
const GREETS = {
  blade: [
    "Found you, brave girl. Don’t run—yet.",
    "Footsteps behind you… I keep pace.",
    "Doorway or shadows? I’m close behind.",
    "Say my name and I’ll follow.",
    "Do you want patient… or a little chase?",
    "Let me hear one true thing from today."
  ],
  grayson: [
    "One line at a time. I’m listening.",
    "Tell me one detail I’d notice when I look at you.",
    "Pick: gentle questions or firm direction?",
    "Start with today—one truth.",
    "Heart or head first?",
    "You have my attention. Use it."
  ],
  dylan: [
    "Hands flat on the counter, pretty thing.",
    "Calm tune-up or teasing tune-up?",
    "Tell me what needs fixing tonight.",
    "Slow ride or quick detour?",
    "Want grease on my hands or yours?",
    "Bring me one trouble and I’ll tighten it."
  ],
  silas: [
    "Come closer, muse. Lend me a verse.",
    "Soft, or a little rough on the edges?",
    "Paint me a five-word picture.",
    "Hums or growls first?",
    "What’s tonight’s chorus made of?",
    "Give me a note and I’ll hold it on my tongue."
  ],
  alexander: [
    "Shoes off. I’m leading.",
    "Lights low or city view while we talk?",
    "Short answers from now on.",
    "Tell me what you want me to notice first.",
    "Desk or glass wall?",
    "I’ll take your coat and one weight off your mind."
  ],
  jesse: [
    "Darlin’, park it a spell.",
    "Straight talk—what’d the day do to you?",
    "Sweet or rowdy—your pick.",
    "Porch light on or off?",
    "You hungry or just hungry for trouble?",
    "You been good today, or do I need to fix that?"
  ]
};
const KEEPALIVE = [
  "I’m here. Lead and I’ll follow.",
  "Give me one more detail.",
  "Say it how you want it—I can work with that.",
  "Short and honest—I like that.",
  "I’m listening; make it specific."
];

let greetIndex = Number(localStorage.getItem("bb.greet-"+manParam)||0);
function nextGreet(){
  const arr = GREETS[manParam] || GREETS.blade;
  const line = arr[greetIndex % arr.length];
  greetIndex++; localStorage.setItem("bb.greet-"+manParam, String(greetIndex));
  return line;
}

/* -------------------- Talk to server (brain) with one silent retry -------------------- */
async function askBrain(userText){
  const history = Array.from(log.querySelectorAll(".row")).slice(-20).map(r=>{
    const isMe = r.querySelector(".me");
    return (isMe? "user: " : "bot: ") + r.textContent.trim();
  }).join("\n");

  for (let attempt=0; attempt<2; attempt++){
    try{
      const res = await fetch("/api/brain", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ man:manParam, text:userText, history })
      });
      if (!res.ok) throw new Error("bad");
      const data = await res.json();
      if (data && typeof data.reply === "string" && data.reply.trim()) {
        return data.reply.trim();
      }
      throw new Error("shape");
    }catch(e){
      if (attempt===0){ await new Promise(r=>setTimeout(r, 1000)); continue; }
      return null; // let UI show one gentle line
    }
  }
}

/* -------------------- Send flow -------------------- */
let userMsgCount = 0;

async function handleSend(){
  const text = input.value.trim();
  if (!text) return;

  // Decide standards response immediately (push guidelines early)
  const s = norm(text);

  // Hard bans → strike + modal, block after 3
  if (DISALLOWED_ALWAYS.some(rx => rx.test(s))) {
    row(escapeHtml(text), "me");
    const n = getStrikes()+1; setStrikes(n);
    $("#stdStrike").textContent = (n >= MAX_STRIKES)
      ? `Standards warning ${n} of ${MAX_STRIKES}. This device is now blocked for 30 days.`
      : `Standards warning ${n} of ${MAX_STRIKES}. Three warnings results in a 30-day block.`;
    stdOverlay.style.display="grid"; pauseTimer();
    if (n >= MAX_STRIKES){
      const until = Date.now() + 30*24*60*60*1000;
      localStorage.setItem("bb.blockedUntil", String(until));
    }
    input.value = "";
    return;
  }

  // Explicit but allowed → educational modal once (no strike), keep chat PG-13
  if (!eduShown && EXPLICIT_BUT_ALLOWED.test(s)) {
    row(escapeHtml(text), "me");
    $("#stdIntro").textContent = "We keep chat adult & consensual, PG-13 only (no explicit detail).";
    $("#stdStrike").textContent = "No strike — just a reminder: keep it within PG-13.";
    stdOverlay.style.display="grid"; pauseTimer();
    eduShown = true;
    input.value = "";
    return;
  }

  // Post user line
  row(escapeHtml(text), "me");
  input.value=""; userMsgCount++;

  // keep-alive line every 5 user messages
  if (userMsgCount % 5 === 0){
    row(`<em class="sys">${KEEPALIVE[(userMsgCount/5-1)%KEEPALIVE.length]}</em>`);
  }

  // Ask the brain (PG-13 only)
  const reply = await askBrain(text);

  if (reply === null){
    row(`<em class="sys">Network hiccup. Give me one more line and I’m right here.</em>`);
    return;
  }

  row(escapeHtml(reply), "ai");
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

/* -------------------- Timer controls -------------------- */
function pauseTimer(){ clearInterval(tHandle); }
function resumeTimer(){ if (remaining>0) startTimer(); }

/* -------------------- Init -------------------- */
(function init(){
  row(`<strong>${guy.name}:</strong> ${nextGreet()}`, "ai");
  startTimer();
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ handleSend(); }});
  sendBtn.addEventListener("click", handleSend);
})();
</script>
</body>
</html>
