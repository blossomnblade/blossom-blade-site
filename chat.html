<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blossom & Blade — Chat</title>
  <style>
    :root { --room-bg: url('/images/bg_alexander_boardroom.jpg'); }
    html, body { height: 100% }
    body {
      margin: 0;
      background: #000 var(--room-bg) center/cover fixed no-repeat;
      color: #fff;
      font: 500 16px/1.5 system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
    }
    /* force white text everywhere for readability */
    body, body * { color:#fff !important }

    .pill { position: fixed; top: 16px; right: 16px; background: rgba(0,0,0,.55); border: 1px solid rgba(255,255,255,.25);
      border-radius: 999px; padding: 6px 10px; font-weight: 800; font-size: 12px; backdrop-filter: blur(6px) }

    .wrap { max-width: 1100px; margin: 28px auto; padding: 0 14px 110px }
    .chat { background: rgba(0,0,0,.55); border: 1px solid rgba(255,255,255,.2); border-radius: 16px; padding: 16px; backdrop-filter: blur(8px); }
    .msg { max-width: 70%; margin: 10px 0; padding: 10px 14px; border-radius: 12px; background: rgba(255,255,255,.12); }
    .me { margin-left: auto; background: #ff4da6; color: #000 !important; font-weight:700 }
    .opener { opacity: .95; }

    .inputbar { position: fixed; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.7); border-top: 1px solid rgba(255,255,255,.2);
      padding: 10px 14px; backdrop-filter: blur(8px) }
    .row { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 120px; gap: 10px; }
    #chat-input { background: rgba(0,0,0,.5); border: 1px solid rgba(255,255,255,.25); border-radius: 12px; padding: 12px 14px; }
    #chat-send { border: 0; border-radius: 12px; background: #ff4da6; color: #000; font-weight: 900; cursor: pointer; }
  </style>
</head>
<body>
  <div class="pill">Adults 18+ only</div>
  <div class="wrap">
    <div class="chat" id="chat">
      <div class="msg opener" data-chat-opener>…</div>
    </div>
  </div>

  <div class="inputbar">
    <div class="row">
      <input id="chat-input" placeholder="Say hi…" autocomplete="off" />
      <button id="chat-send">Send</button>
    </div>
  </div>

  <script src="/scripts/brain.js"></script>
  <script>
    // Basic client to call /api/chat with memory
    const chat = document.getElementById('chat');
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send');

    function bubble(text, me=false){
      const div = document.createElement('div');
      div.className = 'msg' + (me ? ' me' : '');
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function send(){
      const text = (input.value || '').trim();
      if(!text) return;
      bubble(text, true);
      input.value = '';

      // teach name + update memory
      BB.learnNameFromMessage(text);
      const params = new URLSearchParams(location.search);
      const man = (params.get('man') || 'alexander').toLowerCase();

      const payload = BB.buildChatPayload({
        room: man,
        text,
        history: [], // optional: wire your own rolling history
        dirty: 'high'
      });

      try{
        const r = await fetch('/api/chat', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        bubble(data.reply || 'Say that again, love.');
      }catch(err){
        bubble('Lost the connection—try again in a sec.');
        console.error(err);
      }
    }

    sendBtn.addEventListener('click', send);
    // enter key is enabled inside brain.js too; this is a safety
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    // apply initial UI (background + opener)
    BB.applyChatUI();
  </script>
</body>
</html>
