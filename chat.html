<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1"
  />
  <title>Chat • Blossom & Blade</title>
  <style>
    :root{
      --bg:#0d0f14; --panel:#121522; --panel-2:#0f1220;
      --ink:#e8eaf2; --ink-dim:#aab0c4; --accent:#c86ad9; --accent-2:#7a5cff;
      --ok:#19d27c; --warn:#ffb347; --bad:#ff5577; --ring:rgba(200,106,217,.3);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 700px at 10% -10%,#171a27 0%,transparent 60%),
                      radial-gradient(900px 600px at 110% 10%,#191c2d 0%,transparent 60%),
                      var(--bg);
      color:var(--ink); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.05);
      background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);
      position:sticky; top:0; z-index:5;
    }
    .brand{font-weight:700; letter-spacing:.4px}
    .coins{font-weight:600}
    .coins b{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:999px}
    main{max-width:1100px; margin:24px auto; padding:0 16px}
    .title{font-weight:800; margin:0 0 10px 4px}
    .trialbar{height:8px; border-radius:999px; background:#1b1e2d; overflow:hidden; margin:6px 4px 18px}
    .trialbar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .chat{
      background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px; padding:14px; min-height:58vh; position:relative;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
    }
    .scroll{height:56vh; overflow:auto; padding:8px 8px 2px}
    .row{max-width:78%; margin:10px 0; padding:12px 14px; border-radius:14px; position:relative}
    .row.me{margin-left:auto; background:rgba(255,255,255,.07)}
    .row.him{background:rgba(122,92,255,.08); border:1px solid rgba(122,92,255,.25)}
    .row.system{background:rgba(255,255,255,.04); color:var(--ink-dim); font-size:.9rem}
    .composer{display:flex; gap:10px; padding:12px 8px 4px}
    .composer input{
      flex:1; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.09);
      color:var(--ink); border-radius:14px; padding:14px 14px; outline:none;
    }
    .composer button{
      background:linear-gradient(180deg,var(--accent),#b356d0);
      color:#fff; border:none; padding:0 18px; border-radius:14px; font-weight:700; cursor:pointer;
      box-shadow:0 6px 18px var(--ring);
    }
    /* coin prompt */
    .coins-pop{
      position:fixed; right:18px; bottom:18px; width:310px; z-index:40;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.09); border-radius:16px; padding:14px; display:none;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }
    .coins-pop h4{margin:0 0 8px; font-size:1rem}
    .coin-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .coin{padding:10px 12px; background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.1);
      border-radius:12px; text-align:center; cursor:pointer; font-weight:700}
    .coin small{display:block; font-weight:600; opacity:.8}
    .coins-pop .meta{font-size:.86rem; color:var(--ink-dim); margin:10px 0 0}
    .coins-pop footer{display:flex; justify-content:space-between; margin-top:10px}
    .link{background:none; border:none; color:var(--ink-dim); text-decoration:underline; cursor:pointer}
    /* standards modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50}
    .sheet{width:min(560px,92vw); background:var(--panel); border:1px solid rgba(255,255,255,.09);
      border-radius:18px; padding:18px}
    .sheet h3{margin:0 0 8px}
    .sheet ul{margin:8px 0 0 18px}
    .sheet footer{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .btn{padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#b356d0); color:#fff; border:none}
    .btn.block{background:rgba(255,85,119,.14); border:1px solid rgba(255,85,119,.35); color:#fff}
    .notice{color:var(--ink-dim); font-size:.9rem}
    .muted{color:var(--ink-dim)}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.06); margin-left:6px; font-size:.86rem}
  </style>
</head>
<body>

<header>
  <div class="brand">Blossom & Blade</div>
  <div class="coins">Coins: <b id="coins">0</b></div>
</header>

<main>
  <h2 class="title" id="guyTitle">Chat</h2>
  <div class="trialbar"><i id="trialFill"></i></div>

  <section class="chat">
    <div id="scroll" class="scroll"></div>

    <div class="composer">
      <input id="input" placeholder="Say hi…" autocomplete="off" />
      <button id="send">Send</button>
    </div>
  </section>
</main>

<!-- Coins popup -->
<aside class="coins-pop" id="coinPop">
  <h4>Unlock <em>advanced</em> chat</h4>
  <div class="coin-grid">
    <button class="coin" data-pack="1"><div>5 coins</div><small>$10</small></button>
    <button class="coin" data-pack="2"><div>25 coins</div><small>$20</small></button>
    <button class="coin" data-pack="3"><div>60 coins</div><small>$40</small></button>
    <button class="coin" data-pack="4"><div>150 coins</div><small>$90</small></button>
  </div>
  <p class="meta">Coins only affect <b>words</b> (no visuals). Never pushy — appears when convo goes that direction.</p>
  <footer>
    <button class="link" id="notNow">Not now</button>
    <button class="link" id="seePricing">Pricing</button>
  </footer>
</aside>

<!-- Standards modal -->
<div class="modal" id="standards">
  <div class="sheet">
    <h3>Community Standards</h3>
    <p class="notice">Adult & consensual only. Some themes aren’t allowed even in Advanced mode:</p>
    <ul>
      <li>Minors / “school boy/girl” / “barely legal” / teen or high-school contexts</li>
      <li>Incest/step-family, non-consent/coercion, intoxication without capacity</li>
      <li>Bestiality/necro, trafficking, extreme bodily fluids, blood/knife “play”</li>
      <li>Hate slurs or targeted harassment</li>
    </ul>
    <p class="notice" id="stdNote">We didn’t send that message. You can adjust and continue.</p>
    <footer>
      <button class="btn primary" id="stdOk">Adjust & continue (PG)</button>
      <button class="btn" id="stdFull">View full standards</button>
      <button class="btn block" id="stdBlock">Block this device</button>
      <button class="btn" id="stdReport">Report</button>
    </footer>
  </div>
</div>

<script>
/* ------------------------------ helpers ------------------------------ */
const $ = sel => document.querySelector(sel);
const row = (html, cls='him') => {
  const el = document.createElement('div');
  el.className = `row ${cls}`;
  el.innerHTML = html;
  $('#scroll').appendChild(el);
  $('#scroll').scrollTop = $('#scroll').scrollHeight;
};
const escapeHtml = s => s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

/* ------------------------------ state ------------------------------ */
const url = new URL(location.href);
const man = (url.searchParams.get('man') || localStorage.getItem('bb.character') || 'blade').toLowerCase();
localStorage.setItem('bb.character', man);

const GUYS = {
  blade:     {name:'Blade Kincaid',    persona:'masked hunter • chase fantasy', greet:[
                "Footsteps behind you… I keep pace.",
                "Found you, brave girl. Don’t run—yet.",
                "Doorway or shadows? I’m close behind."
              ]},
  grayson:   {name:'Grayson Kincaid',  persona:'Viking Dom • red-lit room', greet:[
                "One line at a time. I’m listening.",
                "Say more—I’m here.",
                "You have my focus. Start simple."
              ]},
  dylan:     {name:'Dylan Vale',       persona:'Biker boy • motel garage', greet:[
                "Hands flat on the counter, pretty thing.",
                "Tune-up time. Calm or teasing?",
                "You want guidance, or a slow ride?"
              ]},
  jesse:     {name:'Jesse Granger',    persona:'Cowboy • barn loft', greet:[
                "Darlin’, park it. I talk straight.",
                "Sit a spell—truth first.",
                "Sweet or rowdy—your pick."
              ]},
  silas:     {name:'Silas Lennox',     persona:'Rockstar • tour bus', greet:[
                "Come closer, muse. Lend me a verse.",
                "Give me one true line—I’ll echo it back.",
                "Short and sharp—paint me a five-word picture."
              ]},
  alexander: {name:'Alexander Jackson', persona:'Gentleman • penthouse', greet:[
                "Shoes off. I’m leading. Lights low or city view?",
                "Short answers from now on. What do you want me to notice first?",
                "I’ll set the pace. Stand or sit while we talk?"
              ]}
};
const guy = GUYS[man] || GUYS.blade;

const coinsEl = $('#coins');
const getCoins = () => Number(localStorage.getItem('bb.coins')||0);
const setCoins = n => { localStorage.setItem('bb.coins', String(n)); coinsEl.textContent = n; };

// erotic credits (how many hotter replies remain). 1 coin → 25 replies
const getCredits = () => Number(localStorage.getItem('bb.credits')||0);
const setCredits = n => localStorage.setItem('bb.credits', String(n));

let offeredCoins = false;
let shownHiccup = false;
let msgCount = 0;
let suggestCount = 0; // how often user steers spicy
let violationStrikes = Number(localStorage.getItem('bb.strikes')||0);
const VIOLATION_LIMIT = 3;

// block logic (1 month)
const blockUntil = Number(localStorage.getItem('bb.blockUntil') || 0);
if (Date.now() < blockUntil){
  document.body.innerHTML = `
    <main style="max-width:720px;margin:18vh auto;padding:0 18px;text-align:center">
      <h2>Access blocked</h2>
      <p class="muted">This device is temporarily blocked for community-standards violations.<br>
      Try again on <b>${new Date(blockUntil).toLocaleString()}</b>.</p>
    </main>`;
}

/* ------------------------------ UI init ------------------------------ */
$('#guyTitle').innerHTML = `${guy.name} <span class="pill">${guy.persona}</span>`;
setCoins(getCoins()); // display stored coins
const trial = $('#trialFill');

function startTimer(){
  // 3.5 minutes preview bar — visual only (paywall handled elsewhere)
  const total = 3.5*60*1000;
  const start = Date.now();
  const tick = () => {
    const p = Math.min(1, (Date.now()-start)/total);
    trial.style.width = (p*100)+'%';
    if (p<1) requestAnimationFrame(tick);
  };
  tick();
}

function greet(){
  // rotate through 6 hellos across visits
  const k = `bb.greetIndex.${man}`;
  const i = Number(localStorage.getItem(k)||0);
  const line = guy.greet[i % guy.greet.length];
  localStorage.setItem(k, String(i+1));
  row(`<strong>${guy.name}:</strong> ${escapeHtml(line)}`, 'him');
}

/* ------------------------------ standards ------------------------------ */
const standards = $('#standards');
function openStandards(msg){
  $('#stdNote').textContent = "We didn’t send that message. You can adjust and continue.";
  standards.style.display = 'flex';
}
$('#stdOk').onclick = () => { standards.style.display='none'; };
$('#stdFull').onclick = () => alert('Full standards live on our policy page. (Static note for demo.)');
$('#stdReport').onclick = () => { standards.style.display='none'; alert('Thanks for the report.'); };
$('#stdBlock').onclick = () => {
  const until = Date.now() + 30*24*60*60*1000; // 30 days
  localStorage.setItem('bb.blockUntil', String(until));
  location.reload();
};

const HARD_BANS = [
  /school\s*(boy|girl)|barely\s*legal|teen|high\s*school/i,
  /incest|step-?(mom|dad|sis|bro)|uncle|aunt/i,
  /rape|forced|non-?consent|coercion/i,
  /beast|zoo|necro/i,
  /blood|knife|gore|scat|urine/i,
  /slur|kike|fag|retard|tranny|chink|nigger/i
];

// mild “suggestive” nudges that should NOT trigger modal — they just count toward coin prompt
const SUGGESTIVE = /(kiss|lick|suck|spank|pull my hair|bend me over|rail me|ride me|beg|obedien|dominant|daddy|good girl|naughty)/i;

function checkStandards(userText){
  if (HARD_BANS.some(rx => rx.test(userText))){
    violationStrikes++;
    localStorage.setItem('bb.strikes', String(violationStrikes));
    openStandards(userText);
    if (violationStrikes >= VIOLATION_LIMIT){
      const until = Date.now() + 30*24*60*60*1000;
      localStorage.setItem('bb.blockUntil', String(until));
      alert('Blocked for 30 days due to repeated violations.');
      location.reload();
      return true;
    }
    return true; // blocked this specific message
  }
  return false;
}

/* ------------------------------ coins popup ------------------------------ */
const pop = $('#coinPop');
const showCoins = () => { pop.style.display='block'; };
const hideCoins = () => { pop.style.display='none'; };
$('#notNow').onclick = hideCoins;
$('#seePricing').onclick = () => location.href = 'pay.html';

document.querySelectorAll('.coin').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    // TEST MODE: add coins locally. Stripe comes later.
    const pack = btn.dataset.pack; // 1..4
    const added = ({'1':5,'2':25,'3':60,'4':150})[pack] || 5;
    const newCoins = getCoins()+added;
    setCoins(newCoins);
    hideCoins();
    // auto-spend a coin to credits if user is already trying to steer spicy
    if (suggestCount>0 && getCredits()===0 && newCoins>0){
      spendCoin();
      row(`<em class="muted">Spent 1 coin — unlocked 25 advanced replies.</em>`, 'system');
    }
  });
});

function offerCoinsIfNeeded(){
  if (offeredCoins) return;
  if (getCredits()>0) return;
  // show if convo is warm (>=6 messages) OR 2+ suggestive nudges
  if (msgCount>=6 || suggestCount>=2){ offeredCoins=true; showCoins(); }
}

function spendCoin(){
  const c = getCoins();
  if (c<=0) return false;
  setCoins(c-1);
  setCredits(getCredits()+25); // 1 coin → 25 advanced replies
  return true;
}

/* ------------------------------ chatting ------------------------------ */
const input = $('#input');
const sendBtn = $('#send');
$('#guyTitle').scrollIntoView({block:'nearest'});

async function replyWithAI(context){
  // Call your API route. Falls back to a friendly canned line on any error.
  try{
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        man,
        credits:getCredits(),
        // keep messages short & responsive; follow user lead
        system:`You are ${guy.name} (${guy.persona}). PG-13 by default. If credits>0, you may be more explicit but still classy, following the user's lead. Keep replies 1–2 sentences max. Never repeat the exact same line in an hour.`,
        // server should read last few messages from localStorage-like payload if needed
      })
    });
    if(!res.ok) throw new Error('bad');
    const data = await res.json();
    if (data.flagViolation){ openStandards(data.flagReason||''); return; }
    return (data.reply || '').trim();
  }catch(e){
    return null;
  }
}

async function handleSend(){
  const text = input.value.trim();
  if(!text) return;
  input.value = '';
  msgCount++;
  row(escapeHtml(text), 'me');

  // community standards
  if (checkStandards(text)) { row(`<em class="muted">Message blocked by community standards.</em>`,`system`); offerCoinsIfNeeded(); return; }

  // detect suggestive steering (but NOT a violation)
  if (SUGGESTIVE.test(text)) suggestCount++;

  // advanced credits?
  const advMode = getCredits() > 0;

  // ask server (or fallback)
  let out = await replyWithAI(text);

  if (out==null){
    if (!shownHiccup){
      shownHiccup = true;
      row(`<em class="muted">Network hiccup. Give me one more line and I’m right here.</em>`,'system');
      return;
    } else {
      // tiny canned backup so user isn't stuck
      const backups = [
        "I hear you. Want me gentle or a little bold?",
        "Got it. Keep talking—I’m right here.",
        "Tell me where you want me most tonight."
      ];
      out = backups[(msgCount+man.length)%backups.length];
    }
  }

  // If user is steering spicy but no credits, keep it flirty PG and offer coins
  if (!advMode && SUGGESTIVE.test(text)){
    out = out.replace(/(explicit|dirty|naughty)/gi,'spicy');
    out += " <span class='muted'>(We’ll keep it PG-13 until coins unlock advanced.)</span>";
    offerCoinsIfNeeded();
  }

  // If we are in advanced mode, decrement credits and keep things short & following her lead
  if (advMode){
    const left = Math.max(0, getCredits()-1);
    setCredits(left);
    if (left===0){
      row(`<em class="muted">Your 25 advanced replies are used — back to PG-13.</em>`, 'system');
    }
  }

  row(`<strong>${guy.name}:</strong> ${escapeHtml(out)}`, 'him');

  // gentle offer after warm-up even if not spicy
  offerCoinsIfNeeded();
}

sendBtn.addEventListener('click', handleSend);
input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleSend(); }});

/* ------------------------------ boot ------------------------------ */
(function init(){
  greet();
  startTimer();
  // show current coin count on load
  coinsEl.textContent = getCoins();
})();
</script>
</body>
</html>
