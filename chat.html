<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blossom &amp; Blade — Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />

  <meta name="color-scheme" content="dark">
  <!-- Critical fallback so we never see bullets/white while CSS is fetching -->
  <style>
  /* --- layout & page scroll control --- */
  :root { --composer-h: 84px; }                       /* height we reserve for the composer */
  html, body { height: 100%; margin: 0; background:#0d0f14; color:#cfd6e6; overflow: hidden; }

  .wrap {                                             /* outer page container */
    max-width: 1280px;
    margin: 0 auto;
    min-height: 100dvh;                               /* dynamic viewport for mobile bars */
    display: flex;
    flex-direction: column;
    padding: 12px;
  }

  .row {                                              /* main area (messages | portrait) */
    flex: 1 1 auto;
    min-height: 0;                                    /* allows child to scroll */
    display: grid;
    grid-template-columns: 1fr;                       /* 1 column on mobile */
    gap: 16px;
    overflow: hidden;                                 /* prevent page scrolling */
  }
  @media (min-width: 900px) {
    .row { grid-template-columns: minmax(0,1fr) 360px; } /* messages | portrait on desktop */
  }

  /* --- messages pane (the only thing that scrolls) --- */
  ul#messages {
    list-style: none;
    margin: 0; padding: 0;
    height: 100%;
    overflow: auto;
    scroll-behavior: smooth;
    /* keep last bubble above the pinned composer */
    padding-bottom: calc(var(--composer-h) + 20px);
    scroll-padding-bottom: calc(var(--composer-h) + 20px);
  }
  .bubble {
    display: inline-block;
    background: #0c1926;
    color: #cfd6e6;
    border-radius: 16px;
    padding: 10px 14px;
    max-width: 60ch;
  }

  /* --- portrait (right column) --- */
  .portrait-panel { overflow: auto; }
  .portrait-panel img {
    max-width: 100%;
    height: auto;
    max-height: 70vh;                                 /* don’t force page to scroll */
    object-fit: cover;
    border-radius: 16px;
  }

  /* --- trial chip --- */
  .pill {
    position: fixed; top: 12px; right: 12px; z-index: 60;
    background:#0f1320; border:1px solid #1f2740; color:#cfd6e6;
    border-radius: 999px; padding: 6px 10px; font-size: 12px;
    display: inline-flex; align-items: center; gap: 6px;
  }
  .dot { width: 6px; height: 6px; background:#ff6b6b; border-radius: 999px; display: inline-block; }

  /* --- pinned composer bar --- */
  .composer {
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 50;
    padding: 12px 16px max(12px, env(safe-area-inset-bottom, 0px));
    background: linear-gradient(180deg, rgba(8,10,14,0) 0%, rgba(8,10,14,0.85) 30%, rgba(8,10,14,0.95) 100%);
  }
  .composer form { display: flex; gap: 10px; max-width: 1100px; margin: 0 auto; }
  .composer input { flex: 1; min-width: 0; }

  /* --- mobile tweaks --- */
  @media (max-width: 900px) {
    .row { gap: 12px; }
    .portrait-panel img { max-height: 45vh; }
  }
</style>

  <!-- Cache-busted stylesheet (forces fresh CSS through Vercel CDN) -->
  <link rel="stylesheet" href="/styles/chat.css?v=2025-09-23a">
</head>
<body>
  <header class="wrap" aria-label="Chat header">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <div style="font-weight:700;font-size:18px">Blossom &amp; Blade</div>
        <div id="roomTitle" style="opacity:.8;font-size:14px">—</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <span class="pill" aria-live="polite" id="slowBadge">
          <span class="dot" aria-hidden="true"></span>
          <span id="trialLabel">Trial</span>: <span id="trialTime">6:00</span>
          <span style="opacity:.7">RED</span>
          <span class="dot" style="background:#ff6b6b" aria-hidden="true"></span>
        </span>
        <span class="pill" title="Adults 18+ only">Adults 18+ only</span>
      </div>
    </div>
  </header>

  <main class="wrap row" aria-label="Chat content">
    <!-- Messages column -->
    <section aria-label="Messages">
      <ul id="messages" aria-live="polite"></ul>

      <!-- message templates (JS clones these) -->
      <template id="tpl-user">
        <li class="bubble" data-role="user"></li>
      </template>
      <template id="tpl-assistant">
        <li class="bubble" data-role="assistant"></li>
      </template>
    </section>

    <!-- Portrait column -->
    <aside aria-label="Portrait" style="align-self:flex-start">
      <figure id="portrait" style="margin:0">
        <img id="portraitImg" alt="" style="width:100%;height:auto;border-radius:18px;display:block;object-fit:cover;background:#0f1320" />
        <figcaption id="portraitLabel" style="position:absolute;left:-9999px">Portrait</figcaption>
      </figure>
    </aside>
  </main>

  <!-- Composer -->
  <div class="composer">
    <div class="wrap">
      <form id="composer" autocomplete="off">
        <input id="chatInput" type="text" inputmode="text" placeholder="Say something..." aria-label="Type your message">
        <button id="sendBtn" type="submit" style="border:0;border-radius:999px;padding:10px 18px;background:#ff6b8b;color:#0b0d12;font-weight:700">Send</button>
      </form>
    </div>
  </div>

  <!-- Cache-busted scripts so browsers/CDN don’t serve stale copies -->
  <script src="/scripts/consent.js?v=2025-09-23a" defer></script>
  <script src="/scripts/chat.js?v=2025-09-23a" defer></script>
</body>
</html>
