<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat · Blossom & Blade</title>
<link rel="preload" as="script" href="api/brain.js">
<style>
  :root{
    --room: none;                     /* set by JS per guy */
    --ink:#eef3ff; --ink-d:#c6d0e6;
    --panel: rgba(10,12,18,.42);      /* chat window glass (more translucent) */
    --bubble: rgba(16,18,26,.68);     /* bot bubble */
    --bubble-me: rgba(60,20,60,.62);  /* user bubble */
    --ring: rgba(190,220,255,.22);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    /* per-room background via CSS var so it never “disappears” */
    background: #0a0d12 var(--room) center / cover no-repeat fixed;
  }
  /* soft vignette so bg is visible but readable */
  body::before{
    content:""; position:fixed; inset:0;
    background:
      radial-gradient(1200px 600px at 50% 0%, rgba(255,255,255,.05), transparent 60%),
      radial-gradient(1200px 720px at 50% 100%, rgba(0,0,0,.45), rgba(0,0,0,.75) 70%);
    pointer-events:none;
  }

  header{ display:flex; align-items:center; gap:12px; padding:14px 18px; font-weight:700 }
  .crumb{opacity:.85}
  .name{font-weight:800}
  .bar{ height:6px; margin:0 18px; border-radius:6px;
        background: linear-gradient(90deg,#e8619c, #b66ad5 40%, #7ed0ff) }

  .standards{ position:sticky; top:0; text-align:right; padding:6px 18px 0;
              color:var(--ink-d); font-size:12px }

  .wrap{ max-width:1100px; margin:10px auto 44px; padding:0 18px }
  .panel{
    background: var(--panel);
    border:1px solid var(--ring);
    border-radius:18px;
    box-shadow: 0 24px 60px rgba(0,0,0,.45);
    backdrop-filter: blur(4px);
    padding:18px 18px 12px;
    /* keep the big window size like before */
    min-height: 560px;
  }
  #log{ min-height: 380px }          /* ensures messages don’t “eat” composer */

  .row{ display:flex; margin:14px 0 }
  .row.me{ justify-content:flex-end }
  .bubble{
    padding:12px 14px; max-width:min(720px, 90%);
    border-radius:16px;
    background: var(--bubble);
    border:1px solid rgba(255,255,255,.08);
    box-shadow: 0 6px 18px rgba(0,0,0,.28);
    line-height:1.45;
    color:#fff;
    text-shadow: 0 1px 0 rgba(0,0,0,.45);   /* keeps text crisp on busy bgs */
  }
  .row.me .bubble{
    background: var(--bubble-me);
    border-color: rgba(255,180,250,.18);
  }
  .bubble strong{ font-weight:800 }

  .composer{
    display:flex; gap:10px; margin:16px 4px 8px;
    background: rgba(8,10,14,.50);
    border:1px solid var(--ring); border-radius:14px;
    padding:10px 10px 10px 14px; backdrop-filter: blur(3px);
  }
  #input{
    flex:1; background:transparent; border:0; outline:0;
    color:var(--ink); font:inherit; font-size:16px;
  }
  #input::placeholder{ color:rgba(230,235,255,.7) }
  .send{
    background:#2a2f3f; color:#fff; border:0; border-radius:12px; padding:10px 16px;
    font-weight:800; cursor:pointer;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 6px 16px rgba(0,0,0,.35);
  }
  .send:hover{ filter:brightness(1.08) }

  .note{ color:var(--ink-d); font-size:12px; text-align:center; margin-top:8px }
</style>
</head>
<body>
  <header>
    <div class="crumb">Blossom & Blade</div><div>·</div>
    <div class="name" id="gName">…</div>
  </header>
  <div class="bar"></div>
  <div class="standards">PG-13 by default. We follow your lead, within Community Standards.</div>

  <div class="wrap">
    <div class="panel" id="panel">
      <div id="log"></div>
      <form id="composer" class="composer">
        <input id="input" autocomplete="off" placeholder="Say hi…" />
        <button class="send" id="send" type="submit">Send</button>
      </form>
    </div>
    <div class="note">Site stays PG-13. We follow your lead, but within Community Standards.</div>
  </div>

<script src="api/brain.js"></script>
<script>
  const $ = s => document.querySelector(s);
  const log = $('#log'), input = $('#input'), form = $('#composer'), nameEl = $('#gName');

  function row(html, mine=false){
    const r = document.createElement('div');
    r.className = 'row' + (mine?' me':'');
    r.innerHTML = `<div class="bubble">${html}</div>`;
    log.appendChild(r);
    r.scrollIntoView({behavior:'smooth', block:'end'});
  }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function getParam(k, d=''){ const u=new URL(location.href); return u.searchParams.get(k)||d; }

  const id = getParam('man', localStorage.getItem('bb.character')||'blade');
  const guy = BnB.guys[id] || BnB.guys.blade;
  nameEl.textContent = guy.name;

  /* set room background via CSS var so it always sticks */
  document.body.style.setProperty('--room', `url('${guy.bg}')`);

  /* simple per-guy memory */
  const memKey = `bb.mem.${id}`;
  let mem = {}; try{ mem = JSON.parse(localStorage.getItem(memKey)||'{}'); }catch(e){}
  const save = () => { try{ localStorage.setItem(memKey, JSON.stringify(mem)); }catch(e){} };

  (function init(){
    const idx = (mem.greetIndex || 0) % guy.greetings.length;
    row(`<strong>${guy.name}:</strong> ${guy.greetings[idx]}`);
    mem.greetIndex = idx + 1; save();
  })();

  function learn(text){
    const t = text.toLowerCase();
    mem.interests = mem.interests || {};
    const add = k => mem.interests[k]=(mem.interests[k]||0)+1;
    if(/book|read|library|novel/.test(t)) add('books');
    if(/music|song|guitar|band|concert/.test(t)) add('music');
    if(/coffee|latte|espresso|caffeine/.test(t)) add('coffee');
    if(/cowboy|ranch|rodeo|boots/.test(t)) add('rodeo');
    if(/forest|woods|hike|camp/.test(t)) add('woods');
    if(/city|skyline|penthouse|boardroom|deal/.test(t)) add('city');
    if(/cat|kitten/.test(t)) add('cat');
    if(/dog|puppy/.test(t)) add('dog');

    if(!mem.nickname){
      const top = Object.entries(mem.interests).sort((a,b)=>b[1]-a[1])[0];
      if(top){ const [k]=top; mem.nickname = (guy.nicknames[k]||guy.nicknames.default||'darling'); }
    }
    save();
  }

  function jealousProbe(text){
    if(/\b(boyfriend|husband|ex|date)\b/i.test(text) || (/\b[A-Z][a-z]{2,}\b/.test(text) && /\bhe\b/i.test(text))){
      return guy.jealous(mem.nickname);
    }
    return '';
  }

  function replyTo(text){
    learn(text);
    const spice = jealousProbe(text);
    const out = BnB.reply(guy, text.trim(), mem.nickname);
    return spice ? `${out} ${spice}` : out;
  }

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const val = input.value.trim();
    if(!val) return;
    row(escapeHtml(val), true);
    input.value="";
    setTimeout(()=>row(`<strong>${guy.name}:</strong> ${escapeHtml(replyTo(val))}`), 360);
  });
</script>
</body>
</html>
