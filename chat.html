<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat • Blossom & Blade</title>
  <meta name="description" content="Blossom & Blade chat — adult & consensual conversation within Community Standards." />

  <style>
    :root{
      --bg: url("images/gothic-bg.jpg");
      --panel: #121725;
      --ink: #e9ecf5;
      --muted: #aeb5c6;
      --accent:#c077ff;
      --accent-2:#7cc1ff;
      --pill:#21283a;
      --bubble:#0f1422;
      --user:#272b39;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--ink);
      background: #0b0d12 var(--bg) center/cover fixed no-repeat;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    }
    body::before{
      content:""; position:fixed; inset:0;
      background:linear-gradient(180deg,rgba(8,10,16,.65),rgba(8,10,16,.8));
      z-index:-1;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px 14px 68px }
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:12px;
    }
    .left{ display:flex; align-items:center; gap:12px; min-width:0 }
    .name{ font-weight:800; letter-spacing:.3px }
    .crumb{ font-size:12px; opacity:.75 }
    .trialbar{ height:6px; background:#1a2132; border-radius:99px; overflow:hidden; }
    .trialbar>i{ display:block; height:100%; width:25%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); }
    .panel{
      background:var(--panel); border:1px solid rgba(255,255,255,.06);
      border-radius:18px; box-shadow:0 10px 24px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .stream{ padding:18px; display:flex; flex-direction:column; gap:10px; min-height:320px; max-height:68vh; overflow:auto }
    .row{ display:flex; gap:10px; align-items:flex-end }
    .row.you{ justify-content:flex-end }
    .bubble{
      padding:12px 14px; border-radius:14px 14px 14px 10px;
      background:var(--bubble); border:1px solid rgba(255,255,255,.06);
      max-width:72ch; line-height:1.35; font-size:15px;
      white-space:pre-wrap; word-break:break-word;
    }
    .you .bubble{ background:var(--user); border-color:rgba(255,255,255,.08) }
    .hint{ font-size:12px; opacity:.7; text-align:center; padding:8px }
    .composer{
      display:flex; gap:10px; padding:12px; background:#0e1320;
      border-top:1px solid rgba(255,255,255,.06);
    }
    textarea{
      flex:1; min-height:44px; max-height:132px; resize:vertical;
      background:#0c111c; color:var(--ink); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px 12px; font-size:15px; outline: none;
    }
    textarea:focus{ border-color:rgba(124,193,255,.55); box-shadow:0 0 0 3px rgba(124,193,255,.25) }
    .send{
      padding:0 18px; border-radius:12px; border:0; cursor:pointer;
      background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0d12;
      font-weight:800; min-width:84px;
    }
    .send[disabled]{ opacity:.55; cursor:not-allowed }
    .topline{ display:flex; align-items:center; justify-content:space-between; padding:12px 18px 4px }
    .std-note{ font-size:12px; opacity:.72 }

    /* Standards modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(3,6,12,.6); backdrop-filter: blur(2px); z-index:50;
    }
    .modal.on{ display:grid }
    .box{
      width:min(640px,92vw); background:#121725; border:1px solid rgba(255,255,255,.08);
      border-radius:18px; box-shadow:0 18px 44px rgba(0,0,0,.45); padding:18px 18px 16px;
    }
    .box h3{ margin:0 0 8px; font-size:20px }
    .box ul{ margin:8px 0 12px 18px; line-height:1.5 }
    .actions{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#0f1422; color:var(--ink); cursor:pointer }
    .btn.primary{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0d12; border:0; font-weight:800 }
    .btn.danger{ background:#2a0e14; border-color:#45131c; color:#ffd2d2 }
    .warn{ font-size:12px; opacity:.75; margin-top:6px }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left">
        <div class="name" id="guyName">…</div>
        <div class="crumb" id="crumb"></div>
      </div>
    </header>

    <div class="panel">
      <div class="topline">
        <div style="font-weight:700" id="titleLine">Chat</div>
        <div class="std-note">Site stays PG-13. We follow your lead, but within Community Standards.</div>
      </div>
      <div class="trialbar" aria-hidden="true"><i id="trialFill"></i></div>

      <div class="stream" id="stream" aria-live="polite">
        <div class="row"><div class="bubble">…</div></div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Say hi…"></textarea>
        <button class="send" id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Community Standards modal -->
  <div class="modal" id="stdModal" role="dialog" aria-modal="true" aria-labelledby="stdTitle">
    <div class="box">
      <h3 id="stdTitle">Community Standards</h3>
      <p style="margin:0 0 6px">We keep chat adult & consensual. PG-13 by default. No visuals—words only.</p>
      <ul>
        <li>No <strong>minors</strong>, “school boy/girl”, “barely legal”, teen/high-school contexts.</li>
        <li>No <strong>incest/step-family</strong>, <strong>non-consent/coercion</strong>, intoxication without capacity.</li>
        <li>No <strong>bestiality</strong>, <strong>necrophilia</strong>, trafficking, extreme bodily fluids, blood/knife “play”.</li>
        <li>No hate slurs or targeted harassment.</li>
      </ul>
      <div class="warn" id="stdWarn">We didn't send that last message. Warning <span id="warnCount">1</span> of 3. 3 warnings = 30-day block.</div>
      <div class="actions" style="margin-top:10px">
        <button class="btn primary" id="stdOkay">Okay — keep it PG-13</button>
        <button class="btn danger" id="stdBlock">Block this device</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- Guy directory ---------------- */
    const GUYS = {
      alexander: {
        name: "Alexander Jackson",
        bg: "images/bg_alexander_boardroom.jpg",
        greets: [
          "Lights low or city view while we talk?",
          "Seat’s warm. Tell me one thing your day didn’t give you.",
          "Come in. I pour, you choose: sweet or straight?",
          "I’m listening—do you want gentle or decisive tonight?",
          "Door’s closed. What do you want me to notice first?",
          "Short answers from now on. First move—yours or mine?"
        ]
      },
      dylan: {
        name: "Dylan Vale",
        bg: "images/dylan-garage.jpg",
        greets: [
          "Hands flat on the counter, pretty thing. Calm talk or a teasing tune-up?",
          "I’ve got time and bad ideas. What kind do you want?",
          "Stage lights or shadows? I’ll match your mood.",
          "Tell me the line I shouldn’t cross…and I’ll stand right on it.",
          "What should I hear first—your laugh or your breath?",
          "Slow burn or bright spark?"
        ]
      },
      jesse: {
        name: "Jesse Granger",
        bg: "images/jesse_bg.jpg",
        greets: [
          "Straight talk—what’d the day do to you?",
          "Darlin’, pick: sweet or rowdy?",
          "Boots off. I’ve got patience and bad manners. Which do you want?",
          "Tell me where to drive this—soft shoulder or open road?",
          "Crowd’s gone. Now it’s just us. What are you hungry for?",
          "You look like trouble. Ask me to prove it."
        ]
      },
      grayson: {
        name: "Grayson Kincaid",
        bg: "images/grayson-bg.jpg",
        greets: [
          "Pick: gentle questions or firm direction?",
          "Close the door, love. How honest are we being tonight?",
          "I take my time. Tell me where to start.",
          "Temptation or tenderness first?",
          "Say something I can agree with—or argue about.",
          "You came here on purpose. What was it?"
        ]
      },
      silas: {
        name: "Silas Lennox",
        bg: "images/bg_silas_stage.jpg",
        greets: [
          "Tell me your mood and I’ll tune the lyric to it.",
          "We can talk poetry or sin. Dealer’s choice.",
          "Backstage is quiet. What should echo first?",
          "Confession or request?",
          "I’m all ears—give me the first line.",
          "Do you want me soft-spoken or unrestrained?"
        ]
      },
      blade: {
        name: "Blade Kincaid",
        bg: "images/blade-woods.jpg",
        greets: [
          "Footsteps behind you… I keep pace.",
          "Found you, brave girl. Don’t run—yet.",
          "You’re here. I keep you safe—and a little breathless.",
          "I don’t chase. I collect. What do you want me to keep?",
          "Careful. I like the sound you make when you’re cornered.",
          "Ask me for something I shouldn’t give."
        ]
      }
    };

    /* ---------------- Utilities ---------------- */
    const qs = new URLSearchParams(location.search);
    const man = (qs.get("man") || localStorage.getItem("bb.character") || "grayson").toLowerCase();
    const guy = GUYS[man] || GUYS.grayson;

    // Background & headings
    document.body.style.setProperty("--bg", `url("${guy.bg}")`);
    document.getElementById("guyName").textContent = guy.name;
    document.getElementById("titleLine").textContent = guy.name;
    document.getElementById("crumb").textContent = "Blossom & Blade";

    // Trial fill just for motion
    (function animateFill(){
      const el = document.getElementById("trialFill");
      let w = 8, dir = 1;
      setInterval(()=>{ w += dir*0.6; if (w>86||w<8) dir*=-1; el.style.width = w+"%"; }, 60);
    })();

    const API_PATH = "/api/chat";

    const stream = document.getElementById("stream");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    function row(html, who="bot"){
      const r = document.createElement("div");
      r.className = "row" + (who==="you" ? " you" : "");
      const b = document.createElement("div");
      b.className = "bubble";
      b.innerHTML = html;
      r.appendChild(b);
      stream.appendChild(r);
      stream.scrollTop = stream.scrollHeight;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // local storage helpers
    const KEY_WARN = "bb.warns";
    const KEY_BLOCK = "bb.blockedUntil";
    const KEY_HIST = "bb.hist."+man;

    function getWarns(){ try{ return +localStorage.getItem(KEY_WARN) || 0 }catch(e){ return 0 } }
    function setWarns(n){ try{ localStorage.setItem(KEY_WARN, String(n)); }catch(e){} }
    function blockedUntil(){ try{ return +localStorage.getItem(KEY_BLOCK) || 0 }catch(e){ return 0 } }
    function blockForDays(days){
      const until = Date.now() + days*24*60*60*1000;
      try{ localStorage.setItem(KEY_BLOCK, String(until)); }catch(e){}
    }

    // Standards guard — *tight, not overbroad*
    const BAD = [
      /\b(minor|under\s*age|underage|teen(ager)?|high[-\s]?school|barely\s*legal|school\s*(boy|girl))\b/i,
      /\b(incest|step[-\s]?(mom|mother|dad|father|bro(ther)?|sis(ter)?|family))\b/i,
      /\b(non[-\s]?consensual|non[-\s]?consent|without\s+consent|rape|coercion)\b/i,
      /\b(bestiality|zoophil\w*|animal\s*(play|sex))\b/i,
      /\b(necrophil\w*|corpse)\b/i,
      /\b(blood\s*play|knife\s*play|cut(ting)?\s*play|stab|carve|slit)\b/i,
      /\b(feces|fecal|scat|urine\s*play|piss\s*play|vomit\s*play)\b/i,
      /(nigg|fag|tranny|retard|\bkike\b|\bspic\b)/i
    ];
    function violatesStandards(text){
      let t = (text||"").toLowerCase();
      // Allow “you remind me of college” / “cheerleader outfit” — avoid false hits
      // We only hit if explicit terms above present.
      return BAD.some(rx => rx.test(t));
    }

    // Modal logic
    const modal = document.getElementById("stdModal");
    const warnCountEl = document.getElementById("warnCount");
    document.getElementById("stdOkay").onclick = () => { modal.classList.remove("on"); input.focus(); };
    document.getElementById("stdBlock").onclick = () => { blockForDays(30); modal.classList.remove("on"); hardBlock(); };

    function showStandards(){
      warnCountEl.textContent = String(getWarns()+1);
      modal.classList.add("on");
    }
    function hardBlock(){
      input.disabled = true; sendBtn.disabled = true;
      row("This device is blocked for safety for 30 days.", "bot");
    }

    if (blockedUntil() > Date.now()) hardBlock();

    // Restore history
    try {
      const prev = JSON.parse(localStorage.getItem(KEY_HIST) || "[]");
      stream.innerHTML = "";
      if (prev.length){
        prev.forEach(x => row(escapeHtml(x.text), x.who));
      }
    } catch(e){
      stream.innerHTML = "";
    }

    // Greeting (if no history)
    if (!stream.querySelector(".row")){
      const greet = guy.greets[Math.floor(Math.random()*guy.greets.length)];
      row(`<strong>${guy.name}:</strong> ${escapeHtml(greet)}`);
    }

    function saveHistory(){
      const all = [...stream.querySelectorAll(".row")].map(r => ({
        who: r.classList.contains("you") ? "you" : "bot",
        text: r.querySelector(".bubble").textContent
      }));
      try { localStorage.setItem(KEY_HIST, JSON.stringify(all.slice(-80))); } catch(e){}
    }

    async function send(){
      if (input.disabled) return;
      const text = input.value.trim();
      if (!text) return;

      // Block check
      if (blockedUntil() > Date.now()) return;

      // Standards guard
      if (violatesStandards(text)){
        setWarns(getWarns()+1);
        showStandards();
        // Auto-block on 3
        if (getWarns() >= 3){ blockForDays(30); hardBlock(); }
        return;
      }

      // Echo user
      row(escapeHtml(text), "you");
      saveHistory();
      input.value = ""; input.focus();
      sendBtn.disabled = true; input.disabled = true;

      // Build compact history for API (last 18 turns)
      const turns = [...stream.querySelectorAll(".row")].slice(-18).map(r => ({
        role: r.classList.contains("you") ? "user" : "assistant",
        content: r.querySelector(".bubble").textContent
      }));

      let replied = false;

      try{
        const res = await fetch(API_PATH, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ man, history: turns })
        });
        if (!res.ok) throw new Error("bad status");
        const data = await res.json();
        const txt = (data && data.reply) ? String(data.reply) : "";
        if (txt){
          row(`<strong>${guy.name}:</strong> ${escapeHtml(txt)}`);
          replied = true;
        }
      }catch(e){ /* fall through */ }

      if (!replied){
        // graceful fallback
        const soft = [
          "Network hiccup. Give me one more line and I’m right here.",
          "Say it again for me, slow—I want to hear it properly.",
          "I’m still with you. Nudge me—where do you want this to go?"
        ];
        row(`<em>${escapeHtml(soft[Math.floor(Math.random()*soft.length)])}</em>`);
      }

      saveHistory();
      sendBtn.disabled = false; input.disabled = false;
      input.focus();
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // Keyboard focus on load
    setTimeout(()=>input.focus(), 150);
  </script>
</body>
</html>
