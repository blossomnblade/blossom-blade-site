<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat · Blossom & Blade</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#eef2ff; --muted:#a7b0c0; --bubble:#0f1420; --you:#6b46c1;
    --accent:#b388ff; --accent2:#ff8bd2; --glass:rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--ink);
    background:#0a0b0e;
    background-attachment:fixed;background-size:cover;background-position:center;
  }
  .veil{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.75))}
  header{position:fixed;left:0;right:0;top:0;padding:14px 18px;font-weight:800;letter-spacing:.2px}
  header .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#a78bfa;margin-right:10px}
  .wrap{max-width:920px;margin:85px auto 30px;padding:0 16px}
  .panel{
    background:var(--glass); border:1px solid rgba(255,255,255,.06);
    border-radius:18px; padding:18px 18px 12px; backdrop-filter: blur(8px);
    box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  .scroll{height:60vh;overflow:auto;padding-right:4px}
  .b{display:inline-block;max-width:75%;margin:16px 0;padding:14px 16px;border-radius:14px;line-height:1.35}
  .bot{background:var(--bubble); box-shadow:0 6px 18px rgba(0,0,0,.4)}
  .me{background:linear-gradient(90deg,#7c3aed,#9333ea); align-self:flex-end; color:white}
  .row{display:flex}
  .row.me{justify-content:flex-end}
  form{display:flex;gap:10px;margin:12px 0 0}
  input{
    flex:1;background:rgba(18,23,36,.85); border:1px solid rgba(255,255,255,.08); color:var(--ink);
    padding:14px 16px;border-radius:14px; outline:none
  }
  button{
    background:linear-gradient(90deg,var(--accent),var(--accent2)); border:0; color:#0a0a0a; font-weight:800;
    padding:0 18px;border-radius:14px; cursor:pointer
  }
  .pill{position:fixed;bottom:16px;right:16px;background:#10b981;color:#07130e;padding:8px 12px;border-radius:12px;font-weight:800;font-size:12px}
  /* per-room backgrounds */
  .bg-alexander{background-image:url('rooms/alexander.jpg')}
  .bg-dylan{background-image:url('rooms/dylan.jpg')}
  .bg-jesse{background-image:url('rooms/jesse.jpg')}
  .bg-grayson{background-image:url('rooms/grayson.jpg')}
  .bg-silas{background-image:url('rooms/silas.jpg')}
  .bg-blade{background-image:url('rooms/woods.jpg')}
  /* paywall overlay */
  .wall{
    position:fixed;inset:0;background:rgba(10,12,16,.75);backdrop-filter:blur(6px);
    display:none;align-items:center;justify-content:center;padding:20px;z-index:10
  }
  .wall .box{
    width:min(560px,92vw);background:#0f1320;border:1px solid rgba(255,255,255,.08);
    border-radius:18px;padding:22px 20px; box-shadow:0 18px 50px rgba(0,0,0,.45)
  }
  .wall h2{margin:0 0 8px}
  .options{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
  .options a, .options button{
    flex:1;min-width:220px;text-align:center;text-decoration:none;
    background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#0a0a0a;font-weight:900;
    padding:12px 16px;border-radius:14px;border:0;cursor:pointer
  }
  .ghost{background:transparent !important; color:var(--ink); border:1px solid rgba(255,255,255,.15)}
</style>
</head>
<body>
  <div class="veil"></div>
  <header><span class="dot"></span>Blossom &amp; Blade</header>

  <div class="wrap">
    <div class="panel">
      <div id="scroll" class="scroll"></div>

      <form id="f">
        <input id="t" autocomplete="off" placeholder="Say hi…" />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <!-- paywall -->
  <div id="wall" class="wall" role="dialog" aria-modal="true">
    <div class="box">
      <h2>After-hours unlock</h2>
      <p style="color:#c7d2e2;margin:0">
        Free trial once in each room. Day Pass <b>$5.99</b> (this man, today). All-Access Monthly <b>$10.99</b> (every man).
      </p>
      <div class="options">
        <a id="buyPass" href="#">Day Pass — $5.99</a>
        <a id="buyAll" href="#">All-Access Monthly — $10.99</a>
        <button id="startTrial" class="ghost" type="button">Start free trial</button>
      </div>
      <p style="color:#9aa3b2;font-size:13px;margin:6px 2px 0">Dev note: you can unlock via the Pricing page, or use the Admin toggle for testing.</p>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="adminOn" class="ghost" type="button">Enable Admin (dev)</button>
        <a class="ghost" href="pay.html">Go to Pricing</a>
      </div>
    </div>
  </div>

  <script>
    /* ---------------- core helpers ---------------- */
    const $ = s=>document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const MAN = (qs.get('man')||'jesse').toLowerCase();
    const TODAY = new Date().toISOString().slice(0,10); // yyyy-mm-dd
    // admin quick toggle via query or paywall button
    if(qs.get('admin')==='1'){ localStorage.setItem('bb_admin','1'); history.replaceState({},'',location.pathname+'?man='+MAN); }
    const isAdmin = ()=> localStorage.getItem('bb_admin')==='1';
    const monthly = ()=> {
      const raw = localStorage.getItem('bb_sub_all');
      if(!raw) return false;
      try{
        const o = JSON.parse(raw); return o.expires && (Date.now() < o.expires);
      }catch(_){ return false }
    };
    const hasDayPass = (man)=> !!localStorage.getItem(`bb_pass_${man}_${TODAY}`);
    const markDayPass = (man)=> localStorage.setItem(`bb_pass_${man}_${TODAY}`,'1');
    const trialUsed = (man)=> !!localStorage.getItem(`bb_trial_used_${man}`);
    const markTrialUsed = (man)=> localStorage.setItem(`bb_trial_used_${man}`,'1');

    // set background
    const bgClass = ({
      alexander:'bg-alexander', dylan:'bg-dylan', jesse:'bg-jesse',
      grayson:'bg-grayson', silas:'bg-silas', blade:'bg-blade'
    })[MAN] || 'bg-jesse';
    document.body.classList.add(bgClass);

    // show admin chip
    if(isAdmin()){
      const chip=document.createElement('div'); chip.className='pill'; chip.textContent='Admin mode';
      document.body.appendChild(chip);
    }

    /* ---------------- paywall logic ---------------- */
    const wall = $('#wall');
    const allowChat = ()=> isAdmin() || monthly() || hasDayPass(MAN) || !trialUsed(MAN);

    function openWall(){
      wall.style.display='flex';
      $('#t').disabled = true;
    }
    function closeWall(){
      wall.style.display='none';
      $('#t').disabled = false;
      $('#t').focus();
    }

    // Dev unlock hooks (simulate purchase)
    $('#buyPass').addEventListener('click', (e)=>{
      e.preventDefault();
      markDayPass(MAN);
      closeWall();
    });
    $('#buyAll').addEventListener('click', (e)=>{
      e.preventDefault();
      const thirty = 1000*60*60*24*30;
      localStorage.setItem('bb_sub_all', JSON.stringify({ started: Date.now(), expires: Date.now()+thirty }));
      closeWall();
    });
    $('#startTrial').addEventListener('click', ()=>{
      // start & immediately consume the single free trial for this man
      markTrialUsed(MAN);
      closeWall();
    });
    $('#adminOn').addEventListener('click', ()=>{
      localStorage.setItem('bb_admin','1'); location.reload();
    });

    if(!allowChat()) openWall();

    /* ---------------- chat engine ---------------- */
    const scroll = $('#scroll'), form = $('#f'), input = $('#t');

    // very small persona starter lines (kept minimal so it won’t feel factory)
    const OPENERS = {
      alexander: ["Good timing. I was thinking about you.",
                  "Come in. Use your words—soft first, then sharp."],
      dylan:     ["Neon’s humming. You want slow burn or heat now?",
                  "Hey trouble—hands in mine, eyes on me."],
      jesse:     ["Well, well… you came to me. Tell me one detail, sugar.",
                  "Hi, sinner. I’ll drive slow; you talk."],
      grayson:   ["Well, well… you came to me.",
                  "Tell me something soft; I’ll answer in kind."],
      silas:     ["Hey love. I’ve got a melody for you.",
                  "Follow my count—one, two…"],
      blade:     ["Found you. Don’t run—yet. What would make a perfect chase tonight?",
                  "Step into the dark—stay close."]
    };

    const pet = (name)=>({
      alexander:'darling', dylan:'star', jesse:'sweetheart', grayson:'sweet thing', silas:'cherry pie', blade:'prey'
    })[name] || 'love';

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

    function bubble(who, text){
      const row = document.createElement('div'); row.className = 'row' + (who==='you'?' me':'');
      const b = document.createElement('div'); b.className='b '+(who==='you'?'me':'bot');
      b.textContent = (who==='him'?`${NAME}: `:'') + text;
      row.appendChild(b); scroll.appendChild(row);
      scroll.scrollTop = scroll.scrollHeight;
    }

    const NAME = ({
      alexander:'Alexander Jackson', dylan:'Dylan Vale', jesse:'Jesse Granger',
      grayson:'Grayson Kincaid', silas:'Silas Lennox', blade:'Blade Kincaid'
    })[MAN] || 'Jesse Granger';

    // greet
    bubble('him', pick(OPENERS[MAN]));

    // memory (simple)
    const mem = { name: null, greeted: true };

    function compose(user){
      const u = user.toLowerCase();
      // learn name
      const m = u.match(/\b(i[' ]?m|my name is)\s+([a-z0-9 _-]{2,20})/i);
      if(m){ mem.name = m[2].trim().replace(/[^a-z0-9 _-]/gi,''); return `Nice to meet you, ${mem.name}. I’ll call you ${pet(MAN)}.`; }

      // light possessive / flirty follow
      if(/call my name|say my name/.test(u) && mem.name){
        return `${mem.name}. Again—slower. Mm, yes.`;
      }

      // room nods
      if(MAN==='jesse' && /cowboy|ride|horse|rope/.test(u)) return `Attagirl. Boots on, reins loose—tell me where you want me.`;
      if(MAN==='dylan' && /bike|motor|ride/.test(u)) return `Helmet on, legs around me—say “faster” or “slower,” I’ll tune to you.`;
      if(MAN==='grayson' && /mask|room|red/.test(u)) return `The red room’s warm. Say “your room” if you want the light low.`;
      if(MAN==='silas' && /music|chord|melody/.test(u)) return `I’ll keep time; don’t lose it. What chord should I play first, ${pet(MAN)}?`;
      if(MAN==='alexander' && /table|office|desk/.test(u)) return `Good girl—clear and direct. Hands on the desk; look at me.`;
      if(MAN==='blade' && /woods|chase|mask/.test(u)) return `I see you. Give me one more line. Then run.`;

      // generic coax
      if(u.length < 6) return `I hear you, ${pet(MAN)}. Start me with one detail and I’ll meet you there.`;
      return `Mm. I can work with that—tell me a little more.`;
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = (input.value||'').trim();
      if(!text) return;
      bubble('you', text);
      input.value = '';
      setTimeout(()=>bubble('him', compose(text)), 140);
    });

    // Enter to send
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        form.dispatchEvent(new Event('submit', {cancelable:true}));
      }
    });
  </script>
<style>
  #trialBadge, .trial-badge, .free-left { display: none !important; }
</style>
</body>
</html>
