<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grayson Kincaid — PG-13 Room</title>
<style>
  :root{
    --ink:#e9eef0; --muted:#b9c3cc; --border:rgba(255,255,255,.16);
    --panel:rgba(8,10,12,.70); --tag:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:#0b0b0d url('images/grayson-bg.jpg') center/cover fixed no-repeat;
  }
  header{position:sticky;top:0;z-index:5;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:12px 14px}
  .title{display:flex;align-items:center;gap:10px}
  .crumbs{font-size:12px;color:var(--muted)}
  .chip{font-size:12px;padding:5px 9px;border-radius:999px;background:var(--tag);border:1px solid var(--border);margin-left:6px}

  .chat{
    max-width:980px;margin:18px auto;padding:14px;
    background:var(--panel);border:1px solid var(--border);border-radius:16px;
  }
  .stream{height:62vh;overflow:auto;padding:8px 6px}
  .row{display:flex;margin:8px 0}
  .me{justify-content:flex-end}
  .bubble{
    max-width:70%;padding:10px 14px;border-radius:14px;border:1px solid var(--border);
    background:rgba(255,255,255,.08)
  }
  .mine{background:rgba(82,131,255,.18)}
  .meta{font-size:12px;color:var(--muted);margin:6px 0 4px}
  form{display:flex;gap:8px;margin-top:8px}
  input[type="text"]{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0f1215;color:var(--ink)}
  button{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#2b6fff;color:#fff;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .note{font-size:12px;color:var(--muted);margin:8px 0}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="title">
      <strong style="font-size:18px">Grayson Kincaid</strong>
      <span class="chip">Viking Dom • Red-lit room</span>
    </div>
    <div class="crumbs">PG-13 with subscription • Explicit talk unlocks with coins</div>
  </div>
</header>

<main class="chat">
  <div class="meta">One line at a time. He waits for your reply before continuing.</div>
  <div id="stream" class="stream" aria-live="polite"></div>
  <form id="form">
    <input id="msg" type="text" placeholder="Say something sweet…" autocomplete="off" required/>
    <button id="send" type="submit">Send</button>
  </form>
  <div class="note" id="note">Tip: You’re in <span id="stageLabel">PG-13</span> mode.</div>
</main>

<script>
/* --- tiny helper: get URL params --- */
const qs = new URLSearchParams(location.search);
const stage = qs.get('stage') || (document.cookie.includes('bb_subscriber=1') ? 'subscriber' : 'tease');
document.getElementById('stageLabel').textContent = stage === 'subscriber' ? 'Subscriber' : 'Tease';

/* --- DOM handles --- */
const stream = document.getElementById('stream');
const form   = document.getElementById('form');
const msgInp = document.getElementById('msg');
const sendBtn= document.getElementById('send');

/* --- render bubbles --- */
function addBubble(text, mine=false){
  const row = document.createElement('div');
  row.className = 'row' + (mine?' me':'');
  const b = document.createElement('div');
  b.className = 'bubble' + (mine?' mine':'');
  b.textContent = text;
  row.appendChild(b);
  stream.appendChild(row);
  stream.scrollTop = stream.scrollHeight;
}
let typingEl = null;
function showTyping(){
  typingEl = document.createElement('div');
  typingEl.className = 'row';
  const b = document.createElement('div');
  b.className = 'bubble';
  b.textContent = '…typing';
  typingEl.appendChild(b);
  stream.appendChild(typingEl);
  stream.scrollTop = stream.scrollHeight;
}
function hideTyping(){
  if(typingEl){ typingEl.remove(); typingEl=null; }
}

/* --- first line from Grayson (AI) to start the convo --- */
async function greet(){
  showTyping();
  try{
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ man:'grayson', stage, message:'__GREET__' })
    });
    const data = await res.json();
    hideTyping();
    addBubble(data.reply || "Evening. Tell me one true thing about your day.");
  }catch(e){
    hideTyping();
    addBubble("I’m here, little flame. If I go quiet, refresh and we’ll try again.");
  }
}
greet();

/* --- submit handler: one line, wait for reply --- */
let waiting = false;
form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  if(waiting) return;

  const text = msgInp.value.trim();
  if(!text) return;
  addBubble(text, true);
  msgInp.value = '';
  waiting = true; sendBtn.disabled = true; msgInp.disabled = true;
  showTyping();

  try{
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ man:'grayson', stage, message:text })
    });
    const data = await res.json();
    hideTyping();
    addBubble(data.reply || "(he squeezes your hand, thinking.)");
  }catch(err){
    hideTyping();
    addBubble("Connection hiccup—say that again, slowly.");
  }finally{
    waiting = false; sendBtn.disabled = false; msgInp.disabled = false; msgInp.focus();
  }
});
</script>

</body>
</html>
