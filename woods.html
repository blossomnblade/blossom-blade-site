<script>
  const man = "blade";

  // Stage detection:
  // - default = "tease"
  // - if you set localStorage.setItem('bb_subscriber','1'), rooms send "subscriber"
  // - when coin room later: we’ll call with stage "dirty"
  function getStage() {
    const urlStage = new URLSearchParams(location.search).get("stage");
    if (urlStage) return urlStage; // for testing ?stage=subscriber
    return localStorage.getItem('bb_subscriber') === '1' ? 'subscriber' : 'tease';
  }

  const chat = document.getElementById("chat");
  const typing = document.getElementById("typing");
  const form = document.getElementById("composer");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");

  const conversation = [];

  function bubble(text, who){
    const div = document.createElement("div");
    div.className = "bubble " + (who === "me" ? "me" : "him");
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }
  function setTyping(on){ typing.style.display = on ? "block" : "none"; }

  async function askLLM(userText){
    conversation.push({ role: "user", content: userText });

    setTyping(true);
    try{
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages: conversation, man, stage: getStage() })
      });
      const data = await res.json();
      const reply = data?.reply || "Go slow—tell me again.";
      await new Promise(r=>setTimeout(r, 500 + Math.random()*500));
      bubble(reply, "him");
      conversation.push({ role: "assistant", content: reply });
    }catch(e){
      bubble("Rough signal. Try again, wildflower.", "him");
    }finally{
      setTyping(false);
      input.disabled = false; sendBtn.disabled = false; input.focus();
    }
  }

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;
    bubble(text, "me");
    input.value = "";
    input.disabled = true; sendBtn.disabled = true;
    askLLM(text);
  });

  // Soft openers
  bubble("You found me. Finally.", "him");
  setTimeout(()=>bubble("Tell me what you want—slowly.", "him"), 700);
</script>
